<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeadFlow ‚Äî Commercial Insurance Broker Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0c0f;
  --surface: #111318;
  --surface2: #181c23;
  --border: #222730;
  --accent: #00e5a0;
  --accent2: #0ea5e9;
  --warn: #f59e0b;
  --danger: #ef4444;
  --text: #e8eaf0;
  --text2: #8892a4;
  --hot: #ef4444;
  --warm: #f59e0b;
  --cold: #0ea5e9;
  --closed: #00e5a0;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* AUTH SCREEN */
#authScreen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse at 20% 50%, rgba(0,229,160,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 80% 20%, rgba(14,165,233,0.05) 0%, transparent 50%);
}
.auth-box {
  width: 100%; max-width: 420px; padding: 24px;
}
.auth-logo { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; color: var(--accent); margin-bottom: 4px; }
.auth-logo span { color: var(--text2); font-weight: 400; }
.auth-tagline { font-size: 13px; color: var(--text2); margin-bottom: 32px; }
.auth-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; }
.auth-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.auth-sub { font-size: 12px; color: var(--text2); margin-bottom: 24px; }
.auth-tabs { display: flex; gap: 0; margin-bottom: 24px; background: var(--bg); border-radius: 8px; padding: 3px; }
.auth-tab { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: all 0.15s; color: var(--text2); border: none; background: none; }
.auth-tab.active { background: var(--surface2); color: var(--text); }
.auth-err { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--danger); margin-bottom: 16px; display: none; }
.auth-err.show { display: block; }
.auth-success { background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--accent); margin-bottom: 16px; display: none; }
.auth-success.show { display: block; }

/* TOP NAV */
#appScreen { display: none; }
.nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  background: rgba(10,12,15,0.97); backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 56px;
}
.nav-brand { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--accent); cursor: pointer; letter-spacing: -0.5px; flex-shrink: 0; }
.nav-brand span { color: var(--text2); font-weight: 400; }
.nav-right { display: flex; align-items: center; gap: 16px; }
.nav-clock { font-family: 'Syne', sans-serif; font-size: 13px; color: var(--accent); background: rgba(0,229,160,0.08); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,229,160,0.2); }
.nav-user { font-size: 12px; color: var(--text2); max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.nav-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--accent); }
.nav-status::before { content: ''; width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.nav-signout-btn { background: none; border: 1px solid var(--border); border-radius: 7px; padding: 5px 12px; font-size: 12px; color: var(--text2); cursor: pointer; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
.nav-signout-btn:hover { border-color: var(--danger); color: var(--danger); }

/* TAB BAR */
.tabbar {
  position: fixed; top: 56px; left: 0; right: 0; z-index: 90;
  background: var(--surface); border-bottom: 1px solid var(--border);
  height: 48px; display: flex; align-items: stretch;
  padding: 0 16px; gap: 2px; overflow-x: auto;
}
.tabbar::-webkit-scrollbar { display: none; }
.tab-btn {
  display: flex; align-items: center; gap: 7px;
  padding: 0 16px; font-size: 13px; font-weight: 500; color: var(--text2);
  cursor: pointer; border: none; background: none; white-space: nowrap;
  position: relative; transition: color 0.15s; flex-shrink: 0;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); }
.tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--accent); border-radius: 2px 2px 0 0; }
.tab-icon { font-size: 14px; }
.badge { background: var(--danger); color: #fff; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 8px; }
.badge.green { background: var(--accent); color: #000; }

/* MAIN */
.layout { padding-top: calc(56px + 48px); min-height: 100vh; }
.main { padding: 28px; min-height: calc(100vh - 104px); }
.panel { display: none; }
.panel.active { display: block; }

/* CARDS */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
.card-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.card-sub { font-size: 12px; color: var(--text2); margin-bottom: 16px; }

/* HOME */
.home-greeting { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; margin-bottom: 4px; }
.home-greeting span { color: var(--accent); }
.home-date { font-size: 13px; color: var(--text2); margin-bottom: 24px; }
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
.kpi { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; }
.kpi:hover { border-color: var(--accent); transform: translateY(-2px); }
.kpi-val { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--accent); }
.kpi-label { font-size: 11px; color: var(--text2); margin-top: 2px; }
.quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.quick-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; }
.quick-card:hover { border-color: var(--accent); background: rgba(0,229,160,0.04); }
.quick-card .qc-icon { font-size: 24px; margin-bottom: 8px; }
.quick-card .qc-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.quick-card .qc-desc { font-size: 11px; color: var(--text2); }

/* AUTO BRIEF */
.auto-brief { background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(14,165,233,0.06)); border: 1px solid rgba(0,229,160,0.2); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
.auto-brief-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.auto-brief-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--accent); }
.auto-pill { display: inline-flex; align-items: center; gap: 5px; background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.2); border-radius: 20px; padding: 3px 10px; font-size: 10px; font-weight: 600; color: var(--accent); }
.auto-pill::before { content: ''; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
.brief-items { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.brief-item { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; }
.brief-item-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.brief-item-val { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--text); }
.brief-item-sub { font-size: 11px; color: var(--text2); margin-top: 2px; }

/* BUTTONS */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
.btn-primary { background: var(--accent); color: #000; font-weight: 600; }
.btn-primary:hover { background: #00ffb3; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.2); }
.btn-danger:hover { background: rgba(239,68,68,0.2); }
.btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
.btn-full { width: 100%; justify-content: center; }
.btn-icon { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; cursor: pointer; border: 1px solid var(--border); background: var(--surface2); color: var(--text2); transition: all 0.15s; }
.btn-icon:hover { border-color: var(--accent); color: var(--accent); }

/* FORMS */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.form-input, .form-select, .form-textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; font-size: 13px; color: var(--text); font-family: 'DM Sans', sans-serif; transition: border-color 0.15s; }
.form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 90px; }
.form-select option { background: var(--surface); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* TABLE */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th { padding: 10px 12px; text-align: left; font-size: 10px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); white-space: nowrap; }
td { padding: 10px 12px; border-bottom: 1px solid rgba(34,39,48,0.5); vertical-align: middle; }
tr:hover td { background: rgba(255,255,255,0.02); }
.status-badge { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 600; }
.status-hot { background: rgba(239,68,68,0.12); color: var(--hot); }
.status-warm { background: rgba(245,158,11,0.12); color: var(--warn); }
.status-cold { background: rgba(14,165,233,0.12); color: var(--cold); }
.status-closed { background: rgba(0,229,160,0.12); color: var(--closed); }
.status-emailed { background: rgba(139,92,246,0.12); color: #a78bfa; }
.lead-score { display: inline-flex; align-items: center; gap: 2px; font-size: 10px; font-weight: 700; }
.td-actions { display: flex; gap: 4px; align-items: center; }
.phone-link { color: var(--accent2); text-decoration: none; }
.phone-link:hover { color: var(--accent); }
.tag { display: inline-block; background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 2px 7px; font-size: 10px; color: var(--text2); }

/* SEARCH */
.search-layout { display: grid; grid-template-columns: 1fr 260px; gap: 16px; }
.search-controls { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 16px; }
.search-controls .form-group { margin-bottom: 0; flex: 1; min-width: 140px; }
.result-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; transition: border-color 0.15s; }
.result-card:hover { border-color: rgba(0,229,160,0.3); }
.result-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.result-meta { font-size: 11px; color: var(--text2); margin-bottom: 8px; }
.result-actions { display: flex; gap: 6px; flex-wrap: wrap; }
.result-score { display: inline-flex; align-items: center; background: rgba(245,158,11,0.1); color: var(--warn); font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.directory-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.directory-title { font-size: 12px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
.dir-btn { display: block; width: 100%; text-align: left; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 7px 10px; font-size: 11px; color: var(--text2); cursor: pointer; margin-bottom: 6px; transition: all 0.15s; text-decoration: none; }
.dir-btn:hover { border-color: var(--accent); color: var(--accent); }
.dir-btn:last-child { margin-bottom: 0; }
.search-status { text-align: center; padding: 40px; color: var(--text2); }
.search-status .spin { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* EMAIL */
.email-output { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; min-height: 120px; color: var(--text); }
.wa-bubble { background: #1a3c28; border: 1px solid rgba(0,229,160,0.1); border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; font-size: 13px; line-height: 1.6; cursor: pointer; transition: all 0.15s; }
.wa-bubble:hover { border-color: var(--accent); }
.wa-bubble-label { font-size: 10px; color: var(--accent); font-weight: 600; margin-bottom: 4px; }

/* FOLLOW-UPS */
.followup-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.followup-item.overdue { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.04); }
.followup-item.today { border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.04); }
.followup-left { flex: 1; }
.followup-company { font-weight: 600; font-size: 13px; }
.followup-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.followup-when { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 6px; white-space: nowrap; }
.overdue .followup-when { background: rgba(239,68,68,0.12); color: var(--danger); }
.today .followup-when { background: rgba(245,158,11,0.12); color: var(--warn); }
.upcoming .followup-when { background: rgba(14,165,233,0.12); color: var(--cold); }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
.stat-val { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text2); margin-top: 4px; }
.bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.bar-label { font-size: 11px; color: var(--text2); width: 80px; text-align: right; flex-shrink: 0; }
.bar-track { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.6s ease; }
.bar-val { font-size: 11px; color: var(--text2); width: 30px; }

/* CALL SCRIPT */
.script-step { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 10px; }
.step-num { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.step-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
.step-text { font-size: 13px; color: var(--text2); line-height: 1.6; }
.call-tracker-bar { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 16px; }
.call-count { font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800; color: var(--accent); line-height: 1; }
.call-target-label { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.progress-track { background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 4px; transition: width 0.4s ease; }

/* PROFILE */
.profile-avatar { width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: #000; margin-bottom: 16px; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.modal-sub { font-size: 12px; color: var(--text2); margin-bottom: 20px; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }

/* TOAST */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--accent); border-radius: 10px; padding: 12px 18px; font-size: 13px; color: var(--text); z-index: 300; transform: translateY(100px); opacity: 0; transition: all 0.3s; max-width: 300px; }
.toast.show { transform: translateY(0); opacity: 1; }

/* LOADING */
.loading-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 500; flex-direction: column; gap: 16px; }
.loading-logo { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--accent); }
.loading-spin { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }

.section-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 4px; }
.section-sub { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.empty-state { text-align: center; padding: 48px 20px; color: var(--text2); }
.empty-icon { font-size: 36px; margin-bottom: 12px; }
.empty-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.empty-desc { font-size: 12px; }

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .main { margin-left: 0; padding: 16px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .quick-grid { grid-template-columns: repeat(2, 1fr); }
  .search-layout { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { grid-template-columns: 1fr; }
  .brief-items { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">LeadFlow</div>
  <div class="loading-spin"></div>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen" style="display:none;">
  <div class="auth-box">
    <div class="auth-logo">Lead<span>Flow</span></div>
    <div class="auth-tagline">Work Different.</div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Sign In</button>
        <button class="auth-tab" id="tabSignup" onclick="switchTab('signup')">Create Account</button>
      </div>
      <div id="authErr" class="auth-err"></div>
      <div id="authSuccess" class="auth-success"></div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPassword" placeholder="Your password">
        </div>
        <button class="btn btn-primary btn-full" id="loginBtn" onclick="doLogin()">Sign In</button>
        <div style="text-align:center;margin-top:14px;">
          <button onclick="showForgot()" style="background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;text-decoration:underline;">Forgot password?</button>
        </div>
      </div>

      <!-- SIGNUP -->
      <div id="signupForm" style="display:none;">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="signupName" placeholder="Your full name">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="signupEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signupPassword" placeholder="Min 6 characters">
        </div>
        <div class="form-group">
          <label class="form-label">Branch / Area</label>
          <input type="text" class="form-input" id="signupBranch" placeholder="e.g. Sandton">
        </div>
        <button class="btn btn-primary btn-full" id="signupBtn" onclick="doSignup()">Create Account</button>
      </div>

      <!-- FORGOT -->
      <div id="forgotForm" style="display:none;">
        <div style="margin-bottom:16px;font-size:13px;color:var(--text2);">Enter your email and we will send you a reset link.</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="forgotEmail" placeholder="your@email.com">
        </div>
        <button class="btn btn-primary btn-full" onclick="doForgot()">Send Reset Link</button>
        <div style="text-align:center;margin-top:12px;">
          <button onclick="switchTab('login')" style="background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;text-decoration:underline;">Back to sign in</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen" style="display:none;">
  <nav class="nav">
    <div class="nav-brand" onclick="showPanel('home')">Lead<span>Flow</span></div>
    <div class="nav-right">
      <div id="navClock" class="nav-clock">00:00:00</div>
      <div id="navUser" class="nav-user"></div>
      <div class="nav-status">LIVE</div>
      <button class="nav-signout-btn" onclick="doSignOut()">Sign Out</button>
    </div>
  </nav>

  <nav class="tabbar">
    <button class="tab-btn active" id="nav-home" onclick="showPanel('home')"><span class="tab-icon">üè†</span>Home</button>
    <button class="tab-btn" id="nav-search" onclick="showPanel('search')"><span class="tab-icon">üîç</span>AI Lead Search</button>
    <button class="tab-btn" id="nav-pipeline" onclick="showPanel('pipeline')"><span class="tab-icon">üìã</span>Pipeline <span class="badge green" id="pipelineBadge">0</span></button>
    <button class="tab-btn" id="nav-email" onclick="showPanel('email')"><span class="tab-icon">‚úâÔ∏è</span>Email Generator</button>
    <button class="tab-btn" id="nav-followups" onclick="showPanel('followups')"><span class="tab-icon">üîî</span>Follow-ups <span class="badge" id="followupBadge">0</span></button>
    <button class="tab-btn" id="nav-stats" onclick="showPanel('stats')"><span class="tab-icon">üìà</span>My Stats</button>
    <button class="tab-btn" id="nav-script" onclick="showPanel('script')"><span class="tab-icon">üìû</span>Call Script</button>
    <button class="tab-btn" id="nav-profile" onclick="showPanel('profile')"><span class="tab-icon">üë§</span>Profile</button>
  </nav>

  <div class="layout">
    <main class="main">

      <!-- HOME -->
      <div class="panel active" id="panel-home">
        <div id="homeGreeting" class="home-greeting">Good morning, <span>Broker</span></div>
        <div id="homeDate" class="home-date"></div>
        <div class="auto-brief">
          <div class="auto-brief-header">
            <div class="auto-brief-title">ü§ñ Daily Autonomous Brief</div>
            <div class="auto-pill">Auto-updated</div>
          </div>
          <div class="brief-items">
            <div class="brief-item">
              <div class="brief-item-label">Overdue Follow-ups</div>
              <div class="brief-item-val" id="briefOverdue">0</div>
              <div class="brief-item-sub">Need attention today</div>
            </div>
            <div class="brief-item">
              <div class="brief-item-label">Hot Leads</div>
              <div class="brief-item-val" id="briefHot">0</div>
              <div class="brief-item-sub">Score 4-5 ‚Äî call first</div>
            </div>
            <div class="brief-item">
              <div class="brief-item-label">Total Pipeline</div>
              <div class="brief-item-val" id="briefPipeline">0</div>
              <div class="brief-item-sub">Active leads</div>
            </div>
          </div>
        </div>
        <div class="kpi-grid">
          <div class="kpi" onclick="showPanel('pipeline')"><div class="kpi-val" id="kpiLeads">0</div><div class="kpi-label">Leads in Pipeline</div></div>
          <div class="kpi" onclick="showPanel('email')"><div class="kpi-val" id="kpiEmails">0</div><div class="kpi-label">Emails Generated</div></div>
          <div class="kpi" onclick="showPanel('script')"><div class="kpi-val" id="kpiCalls">0</div><div class="kpi-label">Calls Logged</div></div>
          <div class="kpi" onclick="showPanel('stats')"><div class="kpi-val" id="kpiDeals">0</div><div class="kpi-label">Deals Closed</div></div>
        </div>
        <div class="quick-grid">
          <div class="quick-card" onclick="showPanel('search')"><div class="qc-icon">üîç</div><div class="qc-title">Find Leads</div><div class="qc-desc">Search any SA industry</div></div>
          <div class="quick-card" onclick="showPanel('email')"><div class="qc-icon">‚úâÔ∏è</div><div class="qc-title">Write Email</div><div class="qc-desc">AI cold email in seconds</div></div>
          <div class="quick-card" onclick="showPanel('followups')"><div class="qc-icon">üîî</div><div class="qc-title">Follow-ups</div><div class="qc-desc">Check who needs a call</div></div>
          <div class="quick-card" onclick="showPanel('pipeline')"><div class="qc-icon">üìã</div><div class="qc-title">Pipeline</div><div class="qc-desc">Track every lead</div></div>
          <div class="quick-card" onclick="showPanel('stats')"><div class="qc-icon">üìà</div><div class="qc-title">My Stats</div><div class="qc-desc">This week's performance</div></div>
          <div class="quick-card" onclick="showPanel('script')"><div class="qc-icon">üìû</div><div class="qc-title">Call Script</div><div class="qc-desc">7-step proven script</div></div>
        </div>
      </div>

      <!-- SEARCH -->
      <div class="panel" id="panel-search">
        <div class="section-title">üîç AI Lead Search</div>
        <div class="section-sub">Real SA businesses. Add directly to pipeline with one click.</div>
        <div class="search-layout">
          <div>
            <div class="card">
              <div class="search-controls">
                <div class="form-group">
                  <label class="form-label">Industry</label>
                  <select class="form-select" id="searchIndustry" onchange="updateDirLinks()">
                    <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
                    <option>Manufacturing</option><option>Hospitality & Restaurants</option><option>Hotels & Accommodation</option>
                    <option>Healthcare & Medical</option><option>Technology & IT</option><option>Legal Services</option>
                    <option>Accounting & Auditing</option><option>Real Estate & Property</option><option>Financial Services</option>
                    <option>Automotive & Car Dealerships</option><option>Engineering</option><option>Mining</option>
                    <option>Agriculture & Farming</option><option>Security Services</option><option>Cleaning Services</option>
                    <option>Printing & Signage</option><option>Recruitment & Staffing</option><option>Marketing & Advertising</option>
                    <option>Events Management</option><option>Catering</option><option>Plumbing & Electrical</option>
                    <option>Solar & Renewable Energy</option><option>Telecommunications</option><option>Education & Training</option>
                    <option>Fitness & Wellness</option><option>Pharmacy</option><option>Dental Practices</option>
                    <option>Veterinary Services</option><option>Taxi & Bus Operators</option><option>Courier & Delivery</option>
                    <option>Warehousing & Storage</option><option>Steel & Metal Fabrication</option><option>Chemical Industry</option>
                    <option>Hardware & Building Supply</option><option>Tyre & Auto Services</option><option>Panel Beating & Spray Paint</option>
                    <option>Petrol Stations & Garages</option><option>Guest Houses & B&B</option><option>Liquor Stores</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" class="form-input" id="searchCity" value="Johannesburg" oninput="updateDirLinks()">
                </div>
                <div class="form-group">
                  <label class="form-label">Province</label>
                  <select class="form-select" id="searchProvince">
                    <option value="">Any</option><option value="Gauteng" selected>Gauteng</option>
                    <option value="Western Cape">Western Cape</option><option value="KwaZulu-Natal">KwaZulu-Natal</option>
                    <option value="Eastern Cape">Eastern Cape</option><option value="Limpopo">Limpopo</option>
                    <option value="Mpumalanga">Mpumalanga</option><option value="North West">North West</option>
                    <option value="Free State">Free State</option><option value="Northern Cape">Northern Cape</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="doSearch()">Search</button>
              </div>
              <div id="searchResults">
                <div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">Ready to search</div><div class="empty-desc">Select industry and city then hit Search</div></div>
              </div>
              <div id="loadMoreWrap" style="text-align:center;padding:16px 0;display:none;">
                <button class="btn btn-secondary" onclick="loadMoreLeads()">Load More Leads</button>
              </div>
            </div>
          </div>
          <div>
            <div class="directory-card">
              <div class="directory-title">üìÇ SA Directories</div>
              <a class="dir-btn" id="dirYP" href="#" target="_blank" onclick="return openDir('yp')">Yellow Pages SA ‚Üó</a>
              <a class="dir-btn" id="dirLI" href="#" target="_blank" onclick="return openDir('li')">LinkedIn ‚Äî Decision Makers ‚Üó</a>
              <a class="dir-btn" id="dirGM" href="#" target="_blank" onclick="return openDir('gm')">Google Maps ‚Üó</a>
            </div>
            <div class="directory-card">
              <div class="directory-title">üèÜ Gov Tenders <span style="font-size:10px;color:var(--accent);font-weight:400;">Hot Leads</span></div>
              <p style="font-size:11px;color:var(--text2);margin-bottom:10px;">Companies that just won tenders need insurance immediately.</p>
              <a class="dir-btn" href="https://www.etenders.gov.za/content/awarded-tenders" target="_blank" rel="noopener">eTenders ‚Äî Awarded Tenders ‚Üó</a>
              <a class="dir-btn" href="https://www.gov.za/documents/government-tender-bulletin" target="_blank" rel="noopener">Gov.za Tender Bulletin ‚Üó</a>
              <a class="dir-btn" href="https://www.treasury.gov.za/divisions/ocpo/procurement/supplychain/tenders.aspx" target="_blank" rel="noopener">National Treasury Tenders ‚Üó</a>
            </div>
            <div class="directory-card">
              <div class="directory-title">üïµÔ∏è Find Decision Makers</div>
              <a class="dir-btn" href="https://www.cipc.co.za/index.php/search-and-buy/" target="_blank" rel="noopener">CIPC ‚Äî Company Directors ‚Üó</a>
              <a class="dir-btn" href="https://www.linkedin.com/search/results/people/" target="_blank" rel="noopener">LinkedIn ‚Äî Find Owner ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

      <!-- PIPELINE -->
      <div class="panel" id="panel-pipeline">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
          <div><div class="section-title">üìã Pipeline</div><div class="section-sub">All your leads. Sorted by score ‚Äî hottest first.</div></div>
          <button class="btn btn-primary" onclick="openAddLead()">+ Add Lead</button>
        </div>
        <div class="card">
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('all')" id="filter-all" style="border-color:var(--accent);color:var(--accent);">All</button>
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('Hot')" id="filter-Hot">üî¥ Hot</button>
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('Warm')" id="filter-Warm">üü° Warm</button>
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('Cold')" id="filter-Cold">üîµ Cold</button>
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('Emailed')" id="filter-Emailed">üìß Emailed</button>
            <button class="btn btn-secondary btn-sm" onclick="filterPipeline('Closed')" id="filter-Closed">‚úÖ Closed</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Score</th><th>Company</th><th>Industry</th><th>Contact</th><th>Phone</th><th>Status</th><th>Follow-up</th><th>Actions</th></tr></thead>
              <tbody id="pipelineBody"></tbody>
            </table>
          </div>
          <div id="pipelineEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon">üìã</div><div class="empty-title">No leads yet</div>
            <div class="empty-desc">Use AI Lead Search or + Add Lead to get started</div>
          </div>
          <div id="pipelineLoading" class="search-status" style="display:none;"><div class="spin"></div><div>Loading leads...</div></div>
        </div>
      </div>

      <!-- EMAIL -->
      <div class="panel" id="panel-email">
        <div class="section-title">‚úâÔ∏è Email Generator</div>
        <div class="section-sub">AI-powered cold emails personalised with your details.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="card-title">Generate Email</div>
            <div class="form-group"><label class="form-label">Company Name</label><input type="text" class="form-input" id="emailCompany" placeholder="e.g. ABC Construction"></div>
            <div class="form-group"><label class="form-label">Industry</label>
              <select class="form-select" id="emailIndustry">
                <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
                <option>Manufacturing</option><option>Healthcare</option><option>Technology</option>
                <option>Legal Services</option><option>Accounting</option><option>Real Estate</option>
                <option>Automotive</option><option>Mining</option><option>Agriculture</option>
                <option>Security</option><option>Education</option><option>Financial Services</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label">Contact Name</label><input type="text" class="form-input" id="emailContact" placeholder="e.g. Mr Dlamini"></div>
            <div class="form-group"><label class="form-label">Email Type</label>
              <select class="form-select" id="emailType">
                <option value="cold">Cold Outreach</option><option value="followup">Follow-up</option><option value="renewal">Renewal Reminder</option>
              </select>
            </div>
            <button class="btn btn-primary btn-full" onclick="generateEmail()">Generate Email</button>
          </div>
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div class="card-title">Generated Email</div>
              <button class="btn btn-secondary btn-sm" onclick="copyEmail()" id="copyEmailBtn" style="display:none;">Copy</button>
            </div>
            <div id="emailOutput" class="email-output">Fill in the form and click Generate.</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">WhatsApp Messages</div>
          <div class="card-sub">Tap any message to open WhatsApp and send directly.</div>
          <div id="waMessages"><div style="color:var(--text2);font-size:13px;">Generate an email first.</div></div>
        </div>
      </div>

      <!-- FOLLOW-UPS -->
      <div class="panel" id="panel-followups">
        <div class="section-title">üîî Follow-up Reminders</div>
        <div class="section-sub">Autopilot tracks every lead. Overdue ones in red.</div>
        <div style="display:flex;gap:12px;margin-bottom:20px;">
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuOverdue" style="color:var(--danger);">0</div><div class="kpi-label">Overdue</div></div>
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuToday" style="color:var(--warn);">0</div><div class="kpi-label">Due Today</div></div>
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuUpcoming">0</div><div class="kpi-label">Upcoming (7 days)</div></div>
        </div>
        <div id="followupList"></div>
      </div>

      <!-- STATS -->
      <div class="panel" id="panel-stats">
        <div class="section-title">üìà My Stats</div>
        <div class="section-sub">Your performance overview.</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-val" id="statLeads">0</div><div class="stat-label">Total Leads</div></div>
          <div class="stat-card"><div class="stat-val" id="statEmails">0</div><div class="stat-label">Emails Generated</div></div>
          <div class="stat-card"><div class="stat-val" id="statDeals">0</div><div class="stat-label">Deals Closed</div></div>
          <div class="stat-card"><div class="stat-val" id="statConversion">0%</div><div class="stat-label">Conversion Rate</div></div>
          <div class="stat-card"><div class="stat-val" id="statHot">0</div><div class="stat-label">Hot Leads</div></div>
          <div class="stat-card"><div class="stat-val" id="statCalls">0</div><div class="stat-label">Calls Logged</div></div>
        </div>
        <div class="card">
          <div class="card-title">Weekly Activity</div>
          <div id="barChart" style="margin-top:8px;"></div>
        </div>
        <div class="card">
          <div class="card-title">Log a Closed Deal</div>
          <div class="form-row">
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Company</label><input type="text" class="form-input" id="dealCompany" placeholder="Company name"></div>
            <div style="display:flex;align-items:flex-end;"><button class="btn btn-primary" onclick="logDeal()">Log Win üéâ</button></div>
          </div>
        </div>
      </div>

      <!-- CALL SCRIPT -->
      <div class="panel" id="panel-script">
        <div class="section-title">üìû Cold Call Script</div>
        <div class="section-sub">Proven 7-step framework. Track your daily calls.</div>
        <div class="call-tracker-bar">
          <div style="display:flex;align-items:flex-end;gap:16px;margin-bottom:8px;">
            <div><div class="call-count" id="callCount">0</div><div class="call-target-label">calls today / <span id="callTarget">90</span> target</div></div>
            <div style="display:flex;gap:8px;margin-bottom:4px;">
              <button class="btn btn-primary" onclick="logCall()">+ Log Call</button>
              <button class="btn btn-secondary" onclick="resetCalls()">Reset</button>
            </div>
          </div>
          <div class="progress-track"><div class="progress-fill" id="callProgress" style="width:0%;"></div></div>
        </div>
        <div class="script-step"><div class="step-num">Step 1</div><div class="step-title">Opening</div><div class="step-text">"Good morning, may I speak with the owner or financial manager please?"</div></div>
        <div class="script-step"><div class="step-num">Step 2</div><div class="step-title">Hook</div><div class="step-text" id="scriptHook">"My name is [Your Name] from Outsurance. I just have one quick question about your business insurance."</div></div>
        <div class="script-step"><div class="step-num">Step 3</div><div class="step-title">The Question</div><div class="step-text">"When last did someone review your cover to make sure you are not overpaying or underinsured?"</div></div>
        <div class="script-step"><div class="step-num">Step 4</div><div class="step-title">If Interested</div><div class="step-text">"Great ‚Äî I can do a free 15 min comparison. No obligation. Can we set something up this week?"</div></div>
        <div class="script-step"><div class="step-num">Step 5</div><div class="step-title">If Not Now</div><div class="step-text">"No problem. Can I send you a quick email so you have my details when renewal comes up?"</div></div>
        <div class="script-step"><div class="step-num">Step 6</div><div class="step-title">Objection: Have cover</div><div class="step-text">"Great ‚Äî my question is not whether you have cover, it is whether you have the RIGHT cover at the RIGHT price. May I compare?"</div></div>
        <div class="script-step"><div class="step-num">Step 7</div><div class="step-title">Objection: Too busy</div><div class="step-text">"I completely understand. Can I send you a quick WhatsApp and we find a better time?"</div></div>
      </div>

      <!-- PROFILE -->
      <div class="panel" id="panel-profile">
        <div class="section-title">üë§ Broker Profile</div>
        <div class="section-sub">Your details personalise every email and call script.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="profile-avatar" id="profileAvatar">B</div>
            <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="profName" placeholder="Your full name"></div>
            <div class="form-group"><label class="form-label">Phone Number</label><input type="text" class="form-input" id="profPhone" placeholder="e.g. 082 555 1234"></div>
            <div class="form-group"><label class="form-label">Branch / Area</label><input type="text" class="form-input" id="profBranch" placeholder="e.g. Sandton"></div>
            <div class="form-group"><label class="form-label">Email Address</label><input type="text" class="form-input" id="profEmail" placeholder="your@email.com"></div>
            <div class="form-group"><label class="form-label">Daily Call Target</label><input type="number" class="form-input" id="profTarget" placeholder="90" value="90"></div>
            <button class="btn btn-primary btn-full" onclick="saveProfile()">Save Profile</button>
          </div>
          <div class="card">
            <div class="card-title">Signature Preview</div>
            <div id="sigPreview" style="background:var(--bg);border-radius:8px;padding:16px;font-size:13px;line-height:1.8;color:var(--text2);border:1px solid var(--border);">Save your profile to see your email signature.</div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="addLeadModal">
  <div class="modal">
    <div class="modal-title">+ Add Lead</div>
    <div class="modal-sub">Add a business directly to your pipeline</div>
    <div class="form-group"><label class="form-label">Company Name *</label><input type="text" class="form-input" id="addCompany" placeholder="e.g. ABC Construction"></div>
    <div class="form-group"><label class="form-label">Industry</label>
      <select class="form-select" id="addIndustry">
        <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
        <option>Manufacturing</option><option>Healthcare</option><option>Technology</option>
        <option>Legal Services</option><option>Accounting</option><option>Real Estate</option>
        <option>Automotive</option><option>Mining</option><option>Agriculture</option>
        <option>Security</option><option>Education</option><option>Other</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Contact Name</label><input type="text" class="form-input" id="addContact" placeholder="e.g. Mr Dlamini"></div>
      <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="addPhone" placeholder="011 222 3333"></div>
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select class="form-select" id="addStatus"><option value="Cold">Cold</option><option value="Warm">Warm</option><option value="Hot">Hot</option><option value="Emailed">Emailed</option></select>
    </div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="addNotes" placeholder="Any info about this lead..."></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addLeadModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddLead()">Add to Pipeline</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="notesModal">
  <div class="modal">
    <div class="modal-title" id="notesModalTitle">Lead Notes</div>
    <div class="form-group" style="margin-top:16px;"><label class="form-label">Notes</label><textarea class="form-textarea" id="notesText" placeholder="Log what happened, next steps..."></textarea></div>
    <div class="form-group"><label class="form-label">Follow-up Date</label><input type="date" class="form-input" id="notesFollowup"></div>
    <div class="form-group"><label class="form-label">Update Status</label>
      <select class="form-select" id="notesStatus">
        <option value="Cold">Cold</option><option value="Warm">Warm</option><option value="Hot">Hot</option><option value="Emailed">Emailed</option><option value="Closed">Closed</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('notesModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveNotes()">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ SUPABASE ============
var SUPA_URL = 'https://mtnqgnrcukombrklezhe.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bnFnbnJjdWtvbWJya2xlemhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzY1NzQsImV4cCI6MjA4NzQ1MjU3NH0.Y_RBIjB1N_SEwNaLVg85R5wIRkXY199AiGRdqCzGhz8';
var sb = supabase.createClient(SUPA_URL, SUPA_KEY);

var GKEY = 'AIzaSyBQH8CW4F2MKH69yx0pHK1XC1zx6hZpVXE';
var placesService = null;
var currentPageToken = null;
var currentSearchParams = null;
var activeNotesIdx = null;
var currentUser = null;
var leads = [];
var stats = { emails: 0, calls: 0, deals: 0 };
var profile = {};
var currentFilter = 'all';

// ============ INIT ============
window.addEventListener('load', function() {
  sb.auth.getSession().then(function(res) {
    if (res.data && res.data.session) {
      currentUser = res.data.session.user;
      bootApp();
    } else {
      showAuth();
    }
  });
  sb.auth.onAuthStateChange(function(event, session) {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      bootApp();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'none';
      document.getElementById('authScreen').style.display = 'flex';
    }
  });
});

function showAuth() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
}

function bootApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';
  loadAllData().then(function() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    var navUser = document.getElementById('navUser');
    if (navUser && currentUser) navUser.textContent = profile.name || currentUser.email;
    refreshHome();
    updateDirLinks();
    updateCallUI();
    startClock();
  });
}

// ============ LOAD DATA ============
async function loadAllData() {
  try {
    var uid = currentUser.id;
    var [lr, sr, pr] = await Promise.all([
      sb.from('leads').select('*').eq('user_id', uid).order('created_at', { ascending: false }),
      sb.from('stats').select('*').eq('user_id', uid).single(),
      sb.from('profiles').select('*').eq('id', uid).single()
    ]);
    leads = lr.data || [];
    stats = sr.data ? { emails: sr.data.emails || 0, calls: sr.data.calls || 0, deals: sr.data.deals || 0 } : { emails: 0, calls: 0, deals: 0 };
    profile = pr.data || {};
  } catch(e) { console.log('Load error', e); }
}

// ============ AUTH ============
function switchTab(tab) {
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('forgotForm').style.display = tab === 'forgot' ? 'block' : 'none';
  document.getElementById('tabLogin').className = 'auth-tab' + (tab === 'login' ? ' active' : '');
  document.getElementById('tabSignup').className = 'auth-tab' + (tab === 'signup' ? ' active' : '');
  clearAuthMessages();
}
function showForgot() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('forgotForm').style.display = 'block';
  document.getElementById('tabLogin').className = 'auth-tab';
  clearAuthMessages();
}
function showAuthErr(msg) { var el = document.getElementById('authErr'); el.textContent = msg; el.classList.add('show'); }
function showAuthSuccess(msg) { var el = document.getElementById('authSuccess'); el.textContent = msg; el.classList.add('show'); }
function clearAuthMessages() { document.getElementById('authErr').classList.remove('show'); document.getElementById('authSuccess').classList.remove('show'); }

async function doLogin() {
  clearAuthMessages();
  var email = document.getElementById('loginEmail').value.trim();
  var pass = document.getElementById('loginPassword').value;
  if (!email || !pass) { showAuthErr('Please enter email and password.'); return; }
  var btn = document.getElementById('loginBtn'); btn.disabled = true; btn.textContent = 'Signing in...';
  var { error } = await sb.auth.signInWithPassword({ email: email, password: pass });
  btn.disabled = false; btn.textContent = 'Sign In';
  if (error) showAuthErr(error.message);
}

async function doSignup() {
  clearAuthMessages();
  var name = document.getElementById('signupName').value.trim();
  var email = document.getElementById('signupEmail').value.trim();
  var pass = document.getElementById('signupPassword').value;
  var branch = document.getElementById('signupBranch').value.trim();
  if (!name || !email || !pass) { showAuthErr('Please fill in all required fields.'); return; }
  if (pass.length < 6) { showAuthErr('Password must be at least 6 characters.'); return; }
  var btn = document.getElementById('signupBtn'); btn.disabled = true; btn.textContent = 'Creating account...';
  var { data, error } = await sb.auth.signUp({ email: email, password: pass });
  if (error) { btn.disabled = false; btn.textContent = 'Create Account'; showAuthErr(error.message); return; }
  if (data && data.user) {
    await sb.from('profiles').upsert({ id: data.user.id, name: name, email: email, branch: branch, target: 90 });
  }
  btn.disabled = false; btn.textContent = 'Create Account';
  showAuthSuccess('Account created! Check your email to confirm, then sign in.');
  switchTab('login');
}

async function doForgot() {
  clearAuthMessages();
  var email = document.getElementById('forgotEmail').value.trim();
  if (!email) { showAuthErr('Enter your email address.'); return; }
  var { error } = await sb.auth.resetPasswordForEmail(email);
  if (error) showAuthErr(error.message);
  else showAuthSuccess('Reset link sent! Check your email.');
}

async function doSignOut() {
  await sb.auth.signOut();
  leads = []; stats = { emails:0, calls:0, deals:0 }; profile = {};
}

// ============ CLOCK ============
function startClock() {
  function tick() {
    var now = new Date();
    var h = String(now.getHours()).padStart(2,'0');
    var m = String(now.getMinutes()).padStart(2,'0');
    var s = String(now.getSeconds()).padStart(2,'0');
    var el = document.getElementById('navClock');
    if (el) el.textContent = h + ':' + m + ':' + s;
  }
  tick(); setInterval(tick, 1000);
}

// ============ NAV ============
function showPanel(id) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(n) { n.classList.remove('active'); });
  var p = document.getElementById('panel-' + id);
  if (p) p.classList.add('active');
  var n = document.getElementById('nav-' + id);
  if (n) n.classList.add('active');
  if (id === 'home') refreshHome();
  if (id === 'pipeline') renderPipeline();
  if (id === 'followups') renderFollowups();
  if (id === 'stats') renderStats();
  if (id === 'profile') loadProfileUI();
}

// ============ SCORE ============
function scoreLead(lead) {
  var s = 2;
  var hi = ['Construction','Transport','Manufacturing','Mining','Security','Chemical','Steel','Taxi','Courier'];
  for (var i = 0; i < hi.length; i++) {
    if (lead.industry && lead.industry.indexOf(hi[i]) > -1) { s = 4; break; }
  }
  if (lead.status === 'Hot') s = 5;
  else if (lead.status === 'Warm') s = Math.max(s, 3);
  else if (lead.status === 'Closed') s = 5;
  return s;
}
function scoreStars(n) {
  var c = ['','#555','var(--cold)','var(--warn)','var(--hot)','var(--hot)'];
  return '<span class="lead-score" style="color:' + c[n] + ';">‚òÖ ' + n + '</span>';
}

// ============ HOME ============
function refreshHome() {
  var now = new Date();
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var name = profile.name || 'Broker';
  var hour = now.getHours();
  var greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  var gEl = document.getElementById('homeGreeting');
  if (gEl) gEl.innerHTML = greet + ', <span>' + name + '</span>';
  var dEl = document.getElementById('homeDate');
  if (dEl) dEl.textContent = days[now.getDay()] + ', ' + now.getDate() + ' ' + months[now.getMonth()] + ' ' + now.getFullYear();
  var today = new Date(); today.setHours(0,0,0,0);
  var hot = 0; var overdue = 0;
  for (var i = 0; i < leads.length; i++) {
    if (scoreLead(leads[i]) >= 4) hot++;
    if (leads[i].followup) { var fd = new Date(leads[i].followup); if (fd < today) overdue++; }
  }
  se('briefOverdue', overdue); se('briefHot', hot); se('briefPipeline', leads.length);
  se('kpiLeads', leads.length); se('kpiEmails', stats.emails); se('kpiCalls', stats.calls); se('kpiDeals', stats.deals);
  se('pipelineBadge', leads.length); se('followupBadge', overdue);
}
function se(id, v) { var el = document.getElementById(id); if (el) el.textContent = v; }

// ============ PIPELINE ============
function filterPipeline(f) {
  currentFilter = f;
  document.querySelectorAll('[id^=filter-]').forEach(function(b) { b.style.borderColor = ''; b.style.color = ''; });
  var a = document.getElementById('filter-' + f);
  if (a) { a.style.borderColor = 'var(--accent)'; a.style.color = 'var(--accent)'; }
  renderPipeline();
}

function renderPipeline() {
  var tbody = document.getElementById('pipelineBody');
  var empty = document.getElementById('pipelineEmpty');
  var loading = document.getElementById('pipelineLoading');
  if (!tbody) return;
  if (loading) loading.style.display = 'none';
  var filtered = currentFilter === 'all' ? leads : leads.filter(function(l) { return l.status === currentFilter; });
  filtered = filtered.slice().sort(function(a,b) { return scoreLead(b) - scoreLead(a); });
  if (filtered.length === 0) { tbody.innerHTML = ''; if (empty) empty.style.display = 'block'; return; }
  if (empty) empty.style.display = 'none';
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var lead = filtered[i];
    var realIdx = leads.findIndex(function(l) { return l.id === lead.id; });
    var sc = scoreLead(lead);
    var sc_class = 'status-' + (lead.status || 'cold').toLowerCase();
    var phone = lead.phone ? '<a class="phone-link" href="tel:' + lead.phone + '">' + lead.phone + '</a>' : '<span style="color:var(--text2)">‚Äî</span>';
    var fu = lead.followup ? '<span style="font-size:11px;color:var(--text2);">' + lead.followup + '</span>' : '‚Äî';
    html += '<tr>';
    html += '<td>' + scoreStars(sc) + '</td>';
    html += '<td style="font-weight:600;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(lead.company || '‚Äî') + '</td>';
    html += '<td><span class="tag">' + esc(lead.industry || '‚Äî') + '</span></td>';
    html += '<td style="color:var(--text2);">' + esc(lead.contact || '‚Äî') + '</td>';
    html += '<td>' + phone + '</td>';
    html += '<td><span class="status-badge ' + sc_class + '">' + (lead.status || 'Cold') + '</span></td>';
    html += '<td>' + fu + '</td>';
    html += '<td class="td-actions">';
    html += '<button class="btn-icon" title="Notes" onclick="openNotes(' + realIdx + ')">üìù</button>';
    html += '<button class="btn-icon" title="WhatsApp" onclick="waLead(' + realIdx + ')">üí¨</button>';
    html += '<button class="btn-icon" title="Email" onclick="emailLead(' + realIdx + ')">‚úâÔ∏è</button>';
    html += '<button class="btn-icon" title="Remove" onclick="removeLead(\'' + lead.id + '\')" style="color:var(--danger);">‚úï</button>';
    html += '</td></tr>';
  }
  tbody.innerHTML = html;
}

async function removeLead(id) {
  if (!confirm('Remove this lead?')) return;
  await sb.from('leads').delete().eq('id', id);
  leads = leads.filter(function(l) { return l.id !== id; });
  renderPipeline(); refreshHome(); showToast('Lead removed');
}

function waLead(idx) {
  var lead = leads[idx]; if (!lead) return;
  var name = profile.name || 'your broker';
  var msg = 'Good day, this is ' + name + ' from Outsurance. I noticed ' + (lead.company || 'your business') + ' and wanted to offer a free insurance review. Would you be open to a quick 15 min chat?';
  window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}
function emailLead(idx) {
  var lead = leads[idx]; if (!lead) return;
  showPanel('email');
  setTimeout(function() {
    var c = document.getElementById('emailCompany'); if (c) c.value = lead.company || '';
    var co = document.getElementById('emailContact'); if (co) co.value = lead.contact || '';
  }, 100);
}

// ============ ADD LEAD ============
function openAddLead() {
  ['addCompany','addContact','addPhone','addNotes'].forEach(function(id) { document.getElementById(id).value = ''; });
  openModal('addLeadModal');
}
async function submitAddLead() {
  var company = document.getElementById('addCompany').value.trim();
  if (!company) { showToast('Company name is required'); return; }
  var fu = new Date(); fu.setDate(fu.getDate() + 3);
  var lead = {
    user_id: currentUser.id,
    company: company,
    industry: document.getElementById('addIndustry').value,
    contact: document.getElementById('addContact').value.trim(),
    phone: document.getElementById('addPhone').value.trim(),
    status: document.getElementById('addStatus').value,
    notes: document.getElementById('addNotes').value.trim(),
    followup: fu.toISOString().split('T')[0],
    added_date: new Date().toISOString().split('T')[0]
  };
  var { data, error } = await sb.from('leads').insert(lead).select().single();
  if (error) { showToast('Error saving lead'); return; }
  leads.unshift(data);
  closeModal('addLeadModal');
  renderPipeline(); refreshHome();
  showToast(company + ' added ‚Äî follow-up set in 3 days');
}

// ============ NOTES ============
function openNotes(idx) {
  activeNotesIdx = idx;
  var lead = leads[idx]; if (!lead) return;
  document.getElementById('notesModalTitle').textContent = lead.company || 'Lead Notes';
  document.getElementById('notesText').value = lead.notes || '';
  document.getElementById('notesFollowup').value = lead.followup || '';
  var sel = document.getElementById('notesStatus');
  for (var i = 0; i < sel.options.length; i++) { if (sel.options[i].value === lead.status) { sel.selectedIndex = i; break; } }
  openModal('notesModal');
}
async function saveNotes() {
  if (activeNotesIdx === null) return;
  var lead = leads[activeNotesIdx];
  var updates = {
    notes: document.getElementById('notesText').value,
    followup: document.getElementById('notesFollowup').value || null,
    status: document.getElementById('notesStatus').value
  };
  await sb.from('leads').update(updates).eq('id', lead.id);
  Object.assign(leads[activeNotesIdx], updates);
  closeModal('notesModal'); renderPipeline(); refreshHome(); showToast('Notes saved');
}

// ============ MODALS ============
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ============ SEARCH ============
function initGoogleMaps() {
  var dummy = document.createElement('div');
  placesService = new google.maps.places.PlacesService(dummy);
}
function doSearch() {
  var ind = document.getElementById('searchIndustry').value;
  var city = document.getElementById('searchCity').value.trim() || 'Johannesburg';
  var prov = document.getElementById('searchProvince').value;
  currentSearchParams = { ind: ind, city: city, query: ind + ' ' + city + (prov ? ' ' + prov : '') + ' South Africa' };
  currentPageToken = null;
  document.getElementById('searchResults').innerHTML = '<div class="search-status"><div class="spin"></div><div>Searching SA businesses...</div></div>';
  document.getElementById('loadMoreWrap').style.display = 'none';
  updateDirLinks();
  runSearch(false);
}
function runSearch(append) {
  if (!placesService) { setTimeout(function() { if (placesService) runSearch(append); else buildSampleResults(); }, 1200); return; }
  var req = { query: currentSearchParams.query };
  if (currentPageToken) req.pageToken = currentPageToken;
  placesService.textSearch(req, function(results, status, pagination) {
    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
      currentPageToken = (pagination && pagination.hasNextPage) ? pagination : null;
      document.getElementById('loadMoreWrap').style.display = currentPageToken ? 'block' : 'none';
      renderSearchResults(results, append);
    } else { if (!append) buildSampleResults(); }
  });
}
function loadMoreLeads() {
  if (!currentPageToken) return;
  var prev = currentPageToken; currentPageToken = null;
  document.getElementById('loadMoreWrap').style.display = 'none';
  prev.nextPage();
  setTimeout(function() { runSearch(true); }, 2000);
}
function renderSearchResults(results, append) {
  var container = document.getElementById('searchResults');
  if (!append) container.innerHTML = '';
  var ind = currentSearchParams ? currentSearchParams.ind : 'Business';
  results.forEach(function(r) {
    var name = r.name || 'Unknown';
    var addr = r.formatted_address || r.vicinity || 'South Africa';
    var phone = r.formatted_phone_number || r.international_phone_number || '';
    var rating = r.rating || 0;
    var score = rating >= 4 ? 4 : rating >= 3 ? 3 : 2;
    var div = document.createElement('div');
    div.className = 'result-card';
    var phoneHtml = phone
      ? '<div style="margin:6px 0 10px;display:flex;align-items:center;gap:8px;">' +
        '<span style="font-size:13px;">üìû</span>' +
        '<a class="phone-link" style="font-size:15px;font-weight:700;letter-spacing:0.3px;" href="tel:' + phone.replace(/\s/g,'') + '">' + phone + '</a>' +
        '<button class="btn btn-secondary btn-sm" onclick="window.open(\'tel:' + phone.replace(/\s/g,'') + '\')">Call</button>' +
        '</div>'
      : '<div style="margin:6px 0 10px;font-size:12px;color:var(--text2);font-style:italic;">No phone listed ‚Äî check Google Maps or CIPC</div>';
    div.innerHTML =
      '<div class="result-name">' + esc(name) + '<span class="result-score">Score ' + score + '/5</span></div>' +
      '<div class="result-meta">' + esc(addr) + (rating > 0 ? ' ¬∑ ‚òÖ' + rating.toFixed(1) : '') + '</div>' +
      phoneHtml +
      '<div class="result-actions">' +
      '<button class="btn btn-primary btn-sm" onclick="addSearchLead(\'' + esc2(name) + '\',\'' + esc2(ind) + '\',\'' + esc2(phone) + '\')">+ Add to Pipeline</button>' +
      '<button class="btn btn-secondary btn-sm" onclick="waSearch(\'' + esc2(name) + '\',\'' + esc2(phone) + '\')">WhatsApp</button>' +
      '<button class="btn btn-secondary btn-sm" onclick="findOwner(\'' + esc2(name) + '\')">Find Owner</button>' +
      '</div>';
    container.appendChild(div);
  });
}
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function esc2(s) { return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function buildSampleResults() {
  var ind = currentSearchParams ? currentSearchParams.ind : 'Construction';
  var city = currentSearchParams ? currentSearchParams.city : 'Johannesburg';
  var s = [
    { name: 'Mthembu & Sons ' + ind, formatted_address: 'Sandton, ' + city, formatted_phone_number: '011 ' + rn(), rating: 4.2 },
    { name: city + ' ' + ind + ' Group', formatted_address: 'Rosebank, ' + city, formatted_phone_number: '010 ' + rn(), rating: 3.8 },
    { name: 'SA Prime ' + ind, formatted_address: 'Midrand, Gauteng', formatted_phone_number: '012 ' + rn(), rating: 4.5 },
    { name: 'Nkosi ' + ind + ' Solutions', formatted_address: 'Centurion, Gauteng', formatted_phone_number: '082 ' + rn(), rating: 3.5 },
    { name: 'AfriCon ' + ind + ' (Pty) Ltd', formatted_address: 'Pretoria, Gauteng', formatted_phone_number: '073 ' + rn(), rating: 4.0 },
    { name: 'Capital ' + ind + ' Services', formatted_address: 'Braamfontein, ' + city, formatted_phone_number: '011 ' + rn(), rating: 3.9 },
    { name: 'Soweto ' + ind + ' Contractors', formatted_address: 'Soweto, Gauteng', formatted_phone_number: '079 ' + rn(), rating: 4.1 },
    { name: 'Gold Reef ' + ind, formatted_address: 'Randburg, Gauteng', formatted_phone_number: '010 ' + rn(), rating: 3.7 },
  ];
  var container = document.getElementById('searchResults');
  container.innerHTML = '<div style="font-size:11px;color:var(--text2);padding:8px 12px;background:rgba(245,158,11,0.08);border-radius:8px;border:1px solid rgba(245,158,11,0.2);margin-bottom:12px;">‚ö† Sample data shown. Enable Maps JavaScript API in Google Cloud for live SA business results with real phone numbers.</div>';
  renderSearchResults(s, true);
}
function rn() { return String(Math.floor(100 + Math.random()*900)) + ' ' + String(Math.floor(1000 + Math.random()*9000)); }
async function addSearchLead(name, ind, phone) {
  var fu = new Date(); fu.setDate(fu.getDate() + 3);
  var lead = { user_id: currentUser.id, company: name, industry: ind, contact: '', phone: phone, status: 'Cold', notes: '', followup: fu.toISOString().split('T')[0], added_date: new Date().toISOString().split('T')[0] };
  var { data, error } = await sb.from('leads').insert(lead).select().single();
  if (!error && data) { leads.unshift(data); se('pipelineBadge', leads.length); refreshHome(); showToast(name + ' added to pipeline'); }
}
function waSearch(name, phone) {
  var msg = 'Good day, I am ' + (profile.name || 'your broker') + ' from Outsurance. I came across ' + name + ' and wanted to offer a free business insurance review. Would you have 15 minutes this week?';
  var url = phone ? 'https://wa.me/' + phone.replace(/\D/g,'') + '?text=' + encodeURIComponent(msg) : 'https://wa.me/?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}
function findOwner(name) { window.open('https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent(name + ' owner director'), '_blank'); }

// ============ DIRECTORIES ============
function updateDirLinks() {
  var ind = (document.getElementById('searchIndustry')||{}).value || 'Construction';
  var city = (document.getElementById('searchCity')||{}).value || 'Johannesburg';
  var yp = document.getElementById('dirYP'); if (yp) yp.href = 'https://www.yellowpages.co.za/search?what=' + encodeURIComponent(ind) + '&where=' + encodeURIComponent(city);
  var li = document.getElementById('dirLI'); if (li) li.href = 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(ind + ' ' + city);
  var gm = document.getElementById('dirGM'); if (gm) gm.href = 'https://www.google.com/maps/search/' + encodeURIComponent(ind + ' ' + city);
}
function openDir(which) {
  var ind = (document.getElementById('searchIndustry')||{}).value || 'Construction';
  var city = (document.getElementById('searchCity')||{}).value || 'Johannesburg';
  var urls = { yp: 'https://www.yellowpages.co.za/search?what=' + encodeURIComponent(ind) + '&where=' + encodeURIComponent(city), li: 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(ind + ' ' + city), gm: 'https://www.google.com/maps/search/' + encodeURIComponent(ind + ' ' + city) };
  if (urls[which]) window.open(urls[which], '_blank');
  return false;
}

// ============ EMAIL ============
function generateEmail() {
  var company = document.getElementById('emailCompany').value.trim() || 'your company';
  var industry = document.getElementById('emailIndustry').value;
  var contact = document.getElementById('emailContact').value.trim() || 'there';
  var type = document.getElementById('emailType').value;
  var broker = profile.name || '[Your Name]';
  var phone = profile.phone || '[Your Number]';
  var branch = profile.branch || 'Outsurance';
  var email = '';
  if (type === 'cold') {
    email = 'Subject: Free Business Insurance Review ‚Äî ' + company + '\n\nGood day ' + contact + ',\n\nMy name is ' + broker + ' and I am a commercial insurance specialist at Outsurance, ' + branch + ' branch.\n\nI noticed ' + company + ' operates in the ' + industry + ' sector and wanted to reach out. Many ' + industry + ' businesses are either overpaying or have coverage gaps that could be costly in a claim.\n\nI would like to offer a FREE, no-obligation 15-minute review to:\n‚Ä¢ Compare your current cover against the best available rates\n‚Ä¢ Identify any potential gaps in your policy\n‚Ä¢ Ensure you are correctly covered for your specific risks\n\nAre you available for a quick call this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  } else if (type === 'followup') {
    email = 'Subject: Following up ‚Äî ' + company + ' Insurance Review\n\nGood day ' + contact + ',\n\nI hope you are well. Following up on my previous message regarding a free insurance review for ' + company + '.\n\nThe review takes only 15 minutes and could result in meaningful savings on your current premium.\n\nWould you have a few minutes this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  } else {
    email = 'Subject: Your Policy Renewal is Coming Up ‚Äî ' + company + '\n\nGood day ' + contact + ',\n\nI hope all is well at ' + company + '. Your policy renewal is approaching and I want to make sure you are getting the best possible cover at the best rate.\n\nAs your Outsurance specialist, I will review your current policy and present you with the most competitive options available.\n\nCan we schedule a quick call this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  }
  document.getElementById('emailOutput').textContent = email;
  document.getElementById('copyEmailBtn').style.display = 'inline-flex';
  stats.emails = (stats.emails || 0) + 1;
  updateStatsDB();
  refreshHome();
  generateWA(company, contact, broker, phone);
}
function generateWA(company, contact, broker, phone) {
  var msgs = [
    { label: 'Intro Message', text: 'Good day ' + contact + ', this is ' + broker + ' from Outsurance. I specialise in commercial insurance for businesses like ' + company + '. Do you have 2 min for a quick question about your cover?' },
    { label: 'Follow-up', text: 'Hi ' + contact + ', ' + broker + ' from Outsurance. Following up ‚Äî I have a quick comparison ready for ' + company + '. Can we connect briefly this week?' },
    { label: 'Value Hook', text: 'Hi, ' + broker + ' here from Outsurance. Quick question: when last did someone review your business insurance? Many clients save significantly after a comparison. Worth 15 min?' }
  ];
  var html = '';
  msgs.forEach(function(m) {
    html += '<div class="wa-bubble" onclick="window.open(\'https://wa.me/?text=' + encodeURIComponent(m.text) + '\',\'_blank\')"><div class="wa-bubble-label">' + m.label + ' ‚Äî tap to open WhatsApp</div>' + esc(m.text) + '</div>';
  });
  document.getElementById('waMessages').innerHTML = html;
}
function copyEmail() {
  var text = document.getElementById('emailOutput').textContent;
  navigator.clipboard.writeText(text).then(function() { showToast('Email copied'); }).catch(function() { showToast('Select and copy manually'); });
}

// ============ FOLLOW-UPS ============
function renderFollowups() {
  var today = new Date(); today.setHours(0,0,0,0);
  var overdue = [], todayArr = [], upcoming = [];
  leads.forEach(function(lead, idx) {
    if (!lead.followup) return;
    var fd = new Date(lead.followup); fd.setHours(0,0,0,0);
    if (fd < today) overdue.push({ lead: lead, idx: idx, dateStr: lead.followup });
    else if (fd.getTime() === today.getTime()) todayArr.push({ lead: lead, idx: idx, dateStr: 'Today' });
    else if (fd <= new Date(today.getTime() + 7 * 86400000)) upcoming.push({ lead: lead, idx: idx, dateStr: lead.followup });
  });
  se('fuOverdue', overdue.length); se('fuToday', todayArr.length); se('fuUpcoming', upcoming.length); se('followupBadge', overdue.length);
  var html = '';
  if (!overdue.length && !todayArr.length && !upcoming.length) {
    html = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-title">All clear</div><div class="empty-desc">No follow-ups due. Add leads and set follow-up dates.</div></div>';
  }
  function grp(arr, cls, label) {
    if (!arr.length) return;
    html += '<div style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px;">' + label + '</div>';
    arr.forEach(function(item) {
      html += '<div class="followup-item ' + cls + '"><div class="followup-left"><div class="followup-company">' + esc(item.lead.company||'Unknown') + '</div><div class="followup-meta">' + esc(item.lead.industry||'') + (item.lead.phone ? ' ¬∑ ' + item.lead.phone : '') + '</div></div><span class="followup-when">' + item.dateStr + '</span><button class="btn btn-secondary btn-sm" onclick="openNotes(' + item.idx + ')">Update</button><button class="btn btn-secondary btn-sm" onclick="waLead(' + item.idx + ')">WhatsApp</button></div>';
    });
  }
  grp(overdue, 'overdue', 'Overdue');
  grp(todayArr, 'today', 'Today');
  grp(upcoming, 'upcoming', 'Upcoming (7 days)');
  document.getElementById('followupList').innerHTML = html;
}

// ============ STATS ============
function renderStats() {
  var total = leads.length;
  var hot = 0; var closed = 0;
  leads.forEach(function(l) { if (scoreLead(l) >= 4) hot++; if (l.status === 'Closed') closed++; });
  var conv = total > 0 ? Math.round((closed/total)*100) : 0;
  se('statLeads',total); se('statEmails',stats.emails||0); se('statDeals',stats.deals||0);
  se('statConversion',conv+'%'); se('statHot',hot); se('statCalls',stats.calls||0);
  var days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  var vals = days.map(function() { return Math.floor(Math.random()*20+5); });
  var max = Math.max.apply(null, vals) || 1;
  document.getElementById('barChart').innerHTML = days.map(function(d,i) {
    return '<div class="bar-row"><div class="bar-label">' + d + '</div><div class="bar-track"><div class="bar-fill" style="width:' + Math.round(vals[i]/max*100) + '%;"></div></div><div class="bar-val">' + vals[i] + '</div></div>';
  }).join('');
}
async function logDeal() {
  var c = document.getElementById('dealCompany').value.trim();
  if (!c) { showToast('Enter company name'); return; }
  stats.deals = (stats.deals||0) + 1;
  var idx = leads.findIndex(function(l) { return l.company && l.company.toLowerCase() === c.toLowerCase(); });
  if (idx > -1) { await sb.from('leads').update({ status: 'Closed' }).eq('id', leads[idx].id); leads[idx].status = 'Closed'; }
  updateStatsDB(); renderStats(); document.getElementById('dealCompany').value = '';
  showToast('Deal logged ‚Äî well done! üéâ');
}

// ============ CALL SCRIPT ============
async function logCall() {
  stats.calls = (stats.calls||0) + 1;
  updateStatsDB(); updateCallUI(); refreshHome();
}
function resetCalls() { stats.calls = 0; updateStatsDB(); updateCallUI(); refreshHome(); }
function updateCallUI() {
  var target = profile.target || 90;
  se('callCount', stats.calls||0); se('callTarget', target);
  var pct = Math.min(100, Math.round(((stats.calls||0)/target)*100));
  var p = document.getElementById('callProgress'); if (p) p.style.width = pct + '%';
}
async function updateStatsDB() {
  if (!currentUser) return;
  await sb.from('stats').upsert({ user_id: currentUser.id, emails: stats.emails||0, calls: stats.calls||0, deals: stats.deals||0, updated_at: new Date().toISOString() });
}

// ============ PROFILE ============
function loadProfileUI() {
  document.getElementById('profName').value = profile.name || '';
  document.getElementById('profPhone').value = profile.phone || '';
  document.getElementById('profBranch').value = profile.branch || '';
  document.getElementById('profEmail').value = profile.email || (currentUser ? currentUser.email : '');
  document.getElementById('profTarget').value = profile.target || 90;
  updateSigPreview();
  var pa = document.getElementById('profileAvatar');
  if (pa) pa.textContent = profile.name ? profile.name[0].toUpperCase() : 'B';
}
async function saveProfile() {
  profile.name = document.getElementById('profName').value.trim();
  profile.phone = document.getElementById('profPhone').value.trim();
  profile.branch = document.getElementById('profBranch').value.trim();
  profile.email = document.getElementById('profEmail').value.trim();
  profile.target = parseInt(document.getElementById('profTarget').value) || 90;
  await sb.from('profiles').upsert({ id: currentUser.id, name: profile.name, phone: profile.phone, branch: profile.branch, email: profile.email, target: profile.target });
  updateSigPreview();
  var pa = document.getElementById('profileAvatar'); if (pa && profile.name) pa.textContent = profile.name[0].toUpperCase();
  var sh = document.getElementById('scriptHook'); if (sh && profile.name) sh.textContent = '"My name is ' + profile.name + ' from Outsurance. I just have one quick question about your business insurance."';
  var nu = document.getElementById('navUser'); if (nu) nu.textContent = profile.name || '';
  se('callTarget', profile.target || 90);
  refreshHome(); showToast('Profile saved');
}
function updateSigPreview() {
  var sp = document.getElementById('sigPreview'); if (!sp) return;
  if (!profile.name) { sp.textContent = 'Save your profile to see your signature preview.'; return; }
  sp.innerHTML = '<strong>' + esc(profile.name) + '</strong><br>Commercial Insurance Specialist<br>Outsurance' + (profile.branch ? ' ‚Äî ' + esc(profile.branch) : '') + (profile.phone ? '<br>' + esc(profile.phone) : '') + (profile.email ? '<br>' + esc(profile.email) : '');
}

// ============ TOAST ============
function showToast(msg) {
  var t = document.getElementById('toast');
  t.innerHTML = '<span style="color:var(--accent);font-weight:700;margin-right:8px;">‚úì</span>' + esc(msg);
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}

window.initGoogleMaps = initGoogleMaps;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQH8CW4F2MKH69yx0pHK1XC1zx6hZpVXE&libraries=places&callback=initGoogleMaps"></script>
</body>
</html>
