<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#08090c">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>LeadFlow ‚Äî Work Different.</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:       #08090c;
  --surface:  #0f1117;
  --surface2: #161b24;
  --surface3: #1c2130;
  --border:   #1e2535;
  --border2:  #2a3347;
  --accent:   #00e5a0;
  --accent2:  #0ea5e9;
  --accent3:  #8b5cf6;
  --warn:     #f59e0b;
  --danger:   #ef4444;
  --text:     #e2e8f0;
  --text2:    #7c8da6;
  --text3:    #4a5568;
  --hot:      #ef4444;
  --warm:     #f59e0b;
  --cold:     #0ea5e9;
  --closed:   #00e5a0;
  --radius:   12px;
  --radius-sm: 8px;
  --shadow:   0 4px 24px rgba(0,0,0,0.4);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; min-height: 100dvh; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
button, input, select, textarea { font-family: inherit; }
@keyframes fadeIn  { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes glow    { 0%,100%{box-shadow:0 0 8px rgba(0,229,160,0.2)} 50%{box-shadow:0 0 20px rgba(0,229,160,0.5)} }

/* AUTH SCREEN */
#authScreen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse at 20% 50%, rgba(0,229,160,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 80% 20%, rgba(14,165,233,0.05) 0%, transparent 50%);
}
.auth-box {
  width: 100%; max-width: 420px; padding: 24px;
}
.auth-logo { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; color: var(--accent); margin-bottom: 4px; }
.auth-logo span { color: var(--text2); font-weight: 400; }
.auth-tagline { font-size: 13px; color: var(--text2); margin-bottom: 32px; }
.auth-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; }
.auth-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.auth-sub { font-size: 12px; color: var(--text2); margin-bottom: 24px; }
.auth-tabs { display: flex; gap: 0; margin-bottom: 24px; background: var(--bg); border-radius: 8px; padding: 3px; }
.auth-tab { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: all 0.15s; color: var(--text2); border: none; background: none; }
.auth-tab.active { background: var(--surface2); color: var(--text); }
.auth-err { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--danger); margin-bottom: 16px; display: none; }
.auth-err.show { display: block; }
.auth-success { background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--accent); margin-bottom: 16px; display: none; }
.auth-success.show { display: block; }

/* TOP NAV */
#appScreen { display: none; }
.nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  background: rgba(10,12,15,0.97); backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 56px;
}
.nav-brand { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--accent); cursor: pointer; letter-spacing: -0.5px; flex-shrink: 0; }
.nav-brand span { color: var(--text2); font-weight: 400; }
.nav-right { display: flex; align-items: center; gap: 16px; }
.nav-clock { font-family: 'Syne', sans-serif; font-size: 13px; color: var(--accent); background: rgba(0,229,160,0.08); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,229,160,0.2); }
.nav-user { font-size: 12px; color: var(--text2); max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.nav-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--accent); }
.nav-status::before { content: ''; width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.nav-signout-btn { background: none; border: 1px solid var(--border); border-radius: 7px; padding: 5px 12px; font-size: 12px; color: var(--text2); cursor: pointer; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
.nav-signout-btn:hover { border-color: var(--danger); color: var(--danger); }

/* TAB BAR */
.tabbar {
  position: fixed; top: 56px; left: 0; right: 0; z-index: 90;
  background: var(--surface); border-bottom: 1px solid var(--border);
  height: 48px; display: flex; align-items: stretch;
  padding: 0 16px; gap: 2px; overflow-x: auto;
}
.tabbar::-webkit-scrollbar { display: none; }
.tab-btn {
  display: flex; align-items: center; gap: 7px;
  padding: 0 16px; font-size: 13px; font-weight: 500; color: var(--text2);
  cursor: pointer; border: none; background: none; white-space: nowrap;
  position: relative; transition: color 0.15s; flex-shrink: 0;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); }
.tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--accent); border-radius: 2px 2px 0 0; }
.tab-icon { font-size: 14px; }
.badge { background: var(--danger); color: #fff; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 8px; }
.badge.green { background: var(--accent); color: #000; }

/* LAYOUT */
.layout { padding-top: calc(56px + 48px); min-height: 100vh; display: flex; justify-content: center; background: var(--bg); }
.main { padding: 28px 40px; min-height: calc(100vh - 104px); max-width: 1200px; margin: 0 auto; width: 100%; }
/* panel base - see new CSS block */

/* CARDS */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
.card-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.card-sub { font-size: 12px; color: var(--text2); margin-bottom: 16px; }

/* HOME */
.home-greeting { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; margin-bottom: 4px; }
.home-greeting span { color: var(--accent); }
.home-date { font-size: 13px; color: var(--text2); margin-bottom: 24px; }
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
.kpi { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; }
.kpi:hover { border-color: var(--accent); transform: translateY(-2px); }
.kpi-val { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--accent); }
.kpi-label { font-size: 11px; color: var(--text2); margin-top: 2px; }
.quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.quick-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; }
.quick-card:hover { border-color: var(--accent); background: rgba(0,229,160,0.04); }
.quick-card .qc-icon { font-size: 24px; margin-bottom: 8px; }
.quick-card .qc-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.quick-card .qc-desc { font-size: 11px; color: var(--text2); }

/* AUTO BRIEF */
.auto-brief { background: linear-gradient(135deg, rgba(0,229,160,0.08), rgba(14,165,233,0.06)); border: 1px solid rgba(0,229,160,0.2); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
.auto-brief-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.auto-brief-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--accent); }
.auto-pill { display: inline-flex; align-items: center; gap: 5px; background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.2); border-radius: 20px; padding: 3px 10px; font-size: 10px; font-weight: 600; color: var(--accent); }
.auto-pill::before { content: ''; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
.brief-items { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.brief-item { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; }
.brief-item-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.brief-item-val { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--text); }
.brief-item-sub { font-size: 11px; color: var(--text2); margin-top: 2px; }

/* BUTTONS */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
.btn-primary { background: var(--accent); color: #000; font-weight: 600; }
.btn-primary:hover { background: #00ffb3; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.2); }
.btn-danger:hover { background: rgba(239,68,68,0.2); }
.btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
.btn-full { width: 100%; justify-content: center; }
.btn-icon { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; cursor: pointer; border: 1px solid var(--border); background: var(--surface2); color: var(--text2); transition: all 0.15s; }
.btn-icon:hover { border-color: var(--accent); color: var(--accent); }

/* FORMS */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.form-input, .form-select, .form-textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; font-size: 13px; color: var(--text); font-family: 'DM Sans', sans-serif; transition: border-color 0.15s; }
.form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 90px; }
.form-select option { background: var(--surface); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* TABLE */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th { padding: 10px 12px; text-align: left; font-size: 10px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); white-space: nowrap; }
td { padding: 10px 12px; border-bottom: 1px solid rgba(34,39,48,0.5); vertical-align: middle; }
tr:hover td { background: rgba(255,255,255,0.02); }
.status-badge { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 600; }
.status-hot { background: rgba(239,68,68,0.12); color: var(--hot); }
.status-warm { background: rgba(245,158,11,0.12); color: var(--warn); }
.status-cold { background: rgba(14,165,233,0.12); color: var(--cold); }
.status-closed { background: rgba(0,229,160,0.12); color: var(--closed); }
.status-emailed { background: rgba(139,92,246,0.12); color: #a78bfa; }
.lead-score { display: inline-flex; align-items: center; gap: 2px; font-size: 10px; font-weight: 700; }
.td-actions { display: flex; gap: 4px; align-items: center; }
.phone-link { color: var(--accent2); text-decoration: none; }
.phone-link:hover { color: var(--accent); }
.tag { display: inline-block; background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 2px 7px; font-size: 10px; color: var(--text2); }

/* SEARCH */
.search-layout { display: grid; grid-template-columns: 1fr 260px; gap: 16px; }
.search-controls { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 16px; }
.search-controls .form-group { margin-bottom: 0; flex: 1; min-width: 140px; }
.result-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; transition: border-color 0.15s; }
.result-card:hover { border-color: rgba(0,229,160,0.3); }
.result-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.result-meta { font-size: 11px; color: var(--text2); margin-bottom: 8px; }
.result-actions { display: flex; gap: 6px; flex-wrap: wrap; }
.result-score { display: inline-flex; align-items: center; background: rgba(245,158,11,0.1); color: var(--warn); font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 8px; }
.directory-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.directory-title { font-size: 12px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
.dir-btn { display: block; width: 100%; text-align: left; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 7px 10px; font-size: 11px; color: var(--text2); cursor: pointer; margin-bottom: 6px; transition: all 0.15s; text-decoration: none; }
.dir-btn:hover { border-color: var(--accent); color: var(--accent); }
.dir-btn:last-child { margin-bottom: 0; }
.search-status { text-align: center; padding: 40px; color: var(--text2); }
.search-status .spin { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }
.mini-spin { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }

/* EMAIL */
.email-output { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; min-height: 120px; color: var(--text); }
.wa-bubble { background: #1a3c28; border: 1px solid rgba(0,229,160,0.1); border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; font-size: 13px; line-height: 1.6; cursor: pointer; transition: all 0.15s; }
.wa-bubble:hover { border-color: var(--accent); }
.wa-bubble-label { font-size: 10px; color: var(--accent); font-weight: 600; margin-bottom: 4px; }

/* FOLLOW-UPS */
.followup-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.followup-item.overdue { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.04); }
.followup-item.today { border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.04); }
.followup-left { flex: 1; }
.followup-company { font-weight: 600; font-size: 13px; }
.followup-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.followup-when { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 6px; white-space: nowrap; }
.overdue .followup-when { background: rgba(239,68,68,0.12); color: var(--danger); }
.today .followup-when { background: rgba(245,158,11,0.12); color: var(--warn); }
.upcoming .followup-when { background: rgba(14,165,233,0.12); color: var(--cold); }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
.stat-val { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text2); margin-top: 4px; }
.bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.bar-label { font-size: 11px; color: var(--text2); width: 80px; text-align: right; flex-shrink: 0; }
.bar-track { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.6s ease; }
.bar-val { font-size: 11px; color: var(--text2); width: 30px; }

/* CALL SCRIPT */
.script-step { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 10px; }
.step-num { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.step-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
.step-text { font-size: 13px; color: var(--text2); line-height: 1.6; }
.call-tracker-bar { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 16px; }
.call-count { font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800; color: var(--accent); line-height: 1; }
.call-target-label { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.progress-track { background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 4px; transition: width 0.4s ease; }

/* PROFILE */
.profile-avatar { width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: #000; margin-bottom: 16px; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.modal-sub { font-size: 12px; color: var(--text2); margin-bottom: 20px; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }

/* TOAST */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--accent); border-radius: 10px; padding: 12px 18px; font-size: 13px; color: var(--text); z-index: 300; transform: translateY(100px); opacity: 0; transition: all 0.3s; max-width: 300px; }
.toast.show { transform: translateY(0); opacity: 1; }

/* LOADING */
.loading-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 500; flex-direction: column; gap: 16px; }
.loading-logo { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--accent); }
.loading-spin { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }

.section-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 4px; }
.section-sub { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.empty-state { text-align: center; padding: 48px 20px; color: var(--text2); }
.empty-icon { font-size: 36px; margin-bottom: 12px; }
.empty-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.empty-desc { font-size: 12px; }


.panel { display: none; }
.panel.active { display: block; animation: fadeIn 0.2s ease; }

/* MOBILE BOTTOM NAV */
.mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(8,9,12,0.97); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  display: grid; grid-template-columns: repeat(5, 1fr);
}
.mob-tab {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 4px; cursor: pointer; border: none; background: none;
  color: var(--text2); transition: color 0.15s; -webkit-tap-highlight-color: transparent;
  font-size: 10px; font-weight: 500;
}
.mob-tab .mob-icon { font-size: 22px; }
.mob-tab.active { color: var(--accent); }

/* AGENT SETTINGS TOGGLE */
.toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-track { position: absolute; inset: 0; cursor: pointer; background: var(--border2); border-radius: 12px; transition: 0.2s; }
.toggle-track::after { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; top: 3px; background: var(--text2); border-radius: 50%; transition: 0.2s; }
.toggle input:checked + .toggle-track { background: var(--accent); }
.toggle input:checked + .toggle-track::after { transform: translateX(20px); background: #000; }

/* AGENT LOG */
.agent-log { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; max-height: 260px; overflow-y: auto; font-size: 12px; line-height: 1.8; }
.log-line { padding: 1px 0; border-bottom: 1px solid rgba(30,37,53,0.4); }
.log-line:last-child { border-bottom: none; }
.log-time { color: var(--text2); margin-right: 8px; font-family: monospace; }
.log-success { color: var(--accent); }
.log-warn    { color: var(--warn); }
.log-agent   { color: #c4b5fd; }
.log-info    { color: var(--text); }

/* AGENT ACTION ITEMS */
.agent-action-item { background: rgba(139,92,246,0.06); border: 1px solid rgba(139,92,246,0.15); border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
.agent-action-text { font-size: 13px; color: var(--text); flex: 1; min-width: 180px; }
.agent-action-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.agent-action-btns { display: flex; gap: 6px; }

/* ACTIVITY FEED */
.activity-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.activity-item:last-child { border-bottom: none; }
.activity-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.activity-text { font-size: 13px; color: var(--text); flex: 1; line-height: 1.5; }
.activity-time { font-size: 11px; color: var(--text2); flex-shrink: 0; }

/* FILTER BAR */
.filter-btn { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: none; color: var(--text2); transition: all 0.15s; }
.filter-btn:hover { border-color: var(--accent); color: var(--accent); }
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.07); }

/* MODAL ‚Äî bottom sheet style */
.modal-overlay { align-items: flex-end; }
.modal { border-radius: 20px 20px 0 0; max-width: 520px; }
.modal-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 20px; }

/* KPI hover upgrade */
.kpi { position: relative; overflow: hidden; }
.kpi:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.3); }

/* Stat card accent line */
.stat-card { position: relative; overflow: hidden; }
.stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent), transparent); opacity: 0.4; }

/* Result phone row */
.result-phone-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin: 8px 0 12px; }
.result-phone-num { font-size: 16px; font-weight: 700; color: var(--accent2); text-decoration: none; }
.result-phone-num:hover { color: var(--accent); }
.result-nophone { font-size: 12px; color: var(--text3); font-style: italic; margin: 8px 0 12px; }

/* Profile deploy section */
.deploy-link { display: flex; align-items: center; justify-content: space-between; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 8px 10px; font-size: 12px; color: var(--text2); cursor: pointer; margin-bottom: 6px; transition: all 0.15s; text-decoration: none; }
.deploy-link:hover { border-color: var(--accent); color: var(--accent); }

/* Follow-up items */
.fu-item { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.fu-item.overdue { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.04); }
.fu-item.today   { border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.04); }
.fu-left { flex: 1; min-width: 0; }
.fu-company { font-weight: 600; font-size: 13px; }
.fu-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.fu-when { font-size: 11px; font-weight: 700; padding: 3px 9px; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
.overdue .fu-when { background: rgba(239,68,68,0.12); color: var(--danger); }
.today .fu-when   { background: rgba(245,158,11,0.12); color: var(--warn); }
.upcoming .fu-when{ background: rgba(14,165,233,0.12); color: var(--cold); }
.fu-actions { display: flex; gap: 6px; flex-shrink: 0; }

/* Call tracker */
.call-tracker { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 32px; flex-wrap: wrap; }
.call-count-big { font-family: 'Syne', sans-serif; font-size: 64px; font-weight: 800; color: var(--accent); line-height: 1; }
.call-info { flex: 1; min-width: 200px; }
.call-target-lbl { font-size: 13px; color: var(--text2); margin-bottom: 12px; }
.call-btns { display: flex; gap: 10px; flex-wrap: wrap; }

/* Objections grid */
.objections-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

/* Brief items */
.brief-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.brief-item { background: rgba(0,0,0,0.25); border-radius: 10px; padding: 14px; border: 1px solid rgba(255,255,255,0.04); }
.brief-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.brief-val { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--text); line-height: 1; }
.brief-val.red   { color: var(--danger); }
.brief-val.amber { color: var(--warn); }
.brief-val.green { color: var(--accent); }
.brief-sub { font-size: 11px; color: var(--text2); margin-top: 5px; }

/* Agent brief container */
.agent-brief-wrap { background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(0,229,160,0.05)); border: 1px solid rgba(139,92,246,0.2); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; position: relative; overflow: hidden; }
.agent-brief-wrap::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #8b5cf6, #00e5a0, #0ea5e9); }
.agent-brief-hd { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
.agent-brief-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
.ai-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(139,92,246,0.15); border: 1px solid rgba(139,92,246,0.3); border-radius: 20px; padding: 2px 8px; font-size: 10px; font-weight: 700; color: #c4b5fd; letter-spacing: 0.5px; }
.agent-queue { margin-top: 14px; }
.agent-queue-title { font-size: 11px; font-weight: 700; color: #c4b5fd; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }

/* Agent panel */
.agent-panel-top { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(14,165,233,0.06)); border: 1px solid rgba(139,92,246,0.2); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; }
.agent-panel-top::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #8b5cf6, #0ea5e9, #00e5a0); }
.agent-settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.agent-setting { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.agent-setting-label { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 3px; }
.agent-setting-desc { font-size: 11px; color: var(--text2); }

/* Topnav agent badge */
.agent-status-badge { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: #c4b5fd; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.25); border-radius: 20px; padding: 4px 10px; cursor: pointer; transition: all 0.15s; }
.agent-status-badge::before { content: ''; width: 6px; height: 6px; background: #8b5cf6; border-radius: 50%; animation: pulse 2s infinite; }
.agent-status-badge:hover { background: rgba(139,92,246,0.2); }

@media (max-width: 900px) {
  .search-layout { grid-template-columns: 1fr; }
  .brief-grid-4 { grid-template-columns: repeat(2, 1fr); }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .quick-grid { grid-template-columns: repeat(2, 1fr); }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { grid-template-columns: 1fr; }
  .agent-settings-grid { grid-template-columns: 1fr; }
  .objections-grid { grid-template-columns: 1fr; }
}
@media (max-width: 640px) {
  .app-main { padding: 16px 14px; padding-bottom: 80px; }
  .topnav-clock { display: none; }
  .topnav-user  { display: none; }
  .nav-status   { display: none; }
  .nav-signout-btn { display: none; }
  .tabbar { display: none; }
  .mobile-nav { display: grid !important; }
  .home-greeting { font-size: 24px; }
  .call-count-big { font-size: 48px; }
  .kpi-val { font-size: 26px; }
  .section-title { font-size: 20px; }
}
@media (min-width: 641px) { .mobile-nav { display: none !important; } }

/* BTN AGENT */
.btn-agent { background: rgba(139,92,246,0.12); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.25); }
.btn-agent:hover { background: rgba(139,92,246,0.22); }

/* MODAL FOOTER */
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
.modal-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 20px; }

/* MODAL bottom sheet */
.modal-overlay { align-items: flex-end !important; }
.modal { border-radius: 20px 20px 0 0 !important; max-width: 520px; }

/* BRIEF GRID 4 */
.brief-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

/* SEARCH INFO BAR */
.search-info-bar { background: rgba(14,165,233,0.07); border: 1px solid rgba(14,165,233,0.15); border-radius: 8px; padding: 8px 12px; font-size: 12px; color: var(--accent2); margin-bottom: 12px; }

/* QUICK GRID 3 col */
.quick-grid { grid-template-columns: repeat(3, 1fr); }

/* SECTION HD */
.section-hd { margin-bottom: 24px; }

/* WA BUBBLE UPGRADE */
.wa-bubble { background: #0e1f16; border: 1px solid rgba(0,229,160,0.1); border-radius: 12px; padding: 13px 15px; margin-bottom: 8px; font-size: 13px; line-height: 1.6; cursor: pointer; transition: all 0.15s; }
.wa-bubble:hover { border-color: rgba(0,229,160,0.35); background: #122019; }
.wa-bubble-label { font-size: 10px; color: var(--accent); font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase; }

/* LOADING BRAND */
.loading-brand { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; color: var(--accent); }
.loading-brand span { color: var(--text2); font-weight: 400; }

/* DEPLOY LINK */
.deploy-link { display: flex; align-items: center; justify-content: space-between; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 8px 10px; font-size: 12px; color: var(--text2); cursor: pointer; margin-bottom: 6px; transition: all 0.15s; text-decoration: none; }
.deploy-link:hover { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">LeadFlow</div>
  <div class="loading-spin"></div>
  <div style="font-size:13px;color:var(--text2);margin-top:4px;">Initialising AI Agent...</div>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen" style="display:none;">
  <div class="auth-box">
    <div class="auth-logo">Lead<span>Flow</span></div>
    <div class="auth-tagline">Work Different.</div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Sign In</button>
        <button class="auth-tab" id="tabSignup" onclick="switchTab('signup')">Create Account</button>
      </div>
      <div id="authErr" class="auth-err"></div>
      <div id="authSuccess" class="auth-success"></div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPassword" placeholder="Your password">
        </div>
        <button class="btn btn-primary btn-full" id="loginBtn" onclick="doLogin()">Sign In</button>
        <div style="text-align:center;margin-top:14px;">
          <button onclick="showForgot()" style="background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;text-decoration:underline;">Forgot password?</button>
        </div>
      </div>

      <!-- SIGNUP -->
      <div id="signupForm" style="display:none;">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="signupName" placeholder="Your full name">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="signupEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signupPassword" placeholder="Min 6 characters">
        </div>
        <div class="form-group">
          <label class="form-label">Branch / Area</label>
          <input type="text" class="form-input" id="signupBranch" placeholder="e.g. Sandton">
        </div>
        <button class="btn btn-primary btn-full" id="signupBtn" onclick="doSignup()">Create Account</button>
      </div>

      <!-- FORGOT -->
      <div id="forgotForm" style="display:none;">
        <div style="margin-bottom:16px;font-size:13px;color:var(--text2);">Enter your email and we will send you a reset link.</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="forgotEmail" placeholder="your@email.com">
        </div>
        <button class="btn btn-primary btn-full" onclick="doForgot()">Send Reset Link</button>
        <div style="text-align:center;margin-top:12px;">
          <button onclick="switchTab('login')" style="background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;text-decoration:underline;">Back to sign in</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen" style="display:none;">
  <nav class="nav">
    <div class="nav-brand" onclick="showPanel('home')">Lead<span>Flow</span></div>
    <div class="nav-right">
      <div id="agentBadge" class="agent-status-badge" onclick="showPanel('agent')">ü§ñ AI Agent</div>
      <div id="navClock" class="nav-clock">00:00:00</div>
      <div id="navUser" class="nav-user"></div>
      <div class="nav-status">LIVE</div>
      <button class="nav-signout-btn" onclick="doSignOut()">Sign Out</button>
    </div>
  </nav>

  <nav class="tabbar">
    <button class="tab-btn active" id="nav-home" onclick="showPanel('home')"><span class="tab-icon">üè†</span>Home</button>
    <button class="tab-btn" id="nav-search" onclick="showPanel('search')"><span class="tab-icon">üîç</span>AI Lead Search</button>
    <button class="tab-btn" id="nav-pipeline" onclick="showPanel('pipeline')"><span class="tab-icon">üìã</span>Pipeline <span class="badge green" id="pipelineBadge">0</span></button>
    <button class="tab-btn" id="nav-email" onclick="showPanel('email')"><span class="tab-icon">‚úâÔ∏è</span>Email Generator</button>
    <button class="tab-btn" id="nav-followups" onclick="showPanel('followups')"><span class="tab-icon">üîî</span>Follow-ups <span class="badge" id="followupBadge">0</span></button>
    <button class="tab-btn" id="nav-stats" onclick="showPanel('stats')"><span class="tab-icon">üìà</span>My Stats</button>
    <button class="tab-btn" id="nav-script" onclick="showPanel('script')"><span class="tab-icon">üìû</span>Call Script</button>
    <button class="tab-btn" id="nav-profile" onclick="showPanel('profile')"><span class="tab-icon">üë§</span>Profile</button>
  </nav>

  <div class="layout">
    <main class="main">

      <!-- HOME -->
      <div class="panel active" id="panel-home">
        <div id="homeGreeting" class="home-greeting">Good morning, <span>Broker</span></div>
        <div id="homeDate" class="home-date"></div>
        <div class="agent-brief-wrap">
          <div class="agent-brief-hd">
            <div class="agent-brief-title">Daily Intelligent Brief <span class="ai-badge">ü§ñ AI AGENT</span></div>
            <button class="btn btn-sm btn-agent" onclick="runAgentBrief()">Refresh</button>
          </div>
          <div class="brief-grid-4">
            <div class="brief-item"><div class="brief-label">Overdue Follow-ups</div><div class="brief-val red" id="briefOverdue">0</div><div class="brief-sub">Need attention now</div></div>
            <div class="brief-item"><div class="brief-label">Hot Leads</div><div class="brief-val amber" id="briefHot">0</div><div class="brief-sub">Score 4‚Äì5 ¬∑ call first</div></div>
            <div class="brief-item"><div class="brief-label">Pipeline</div><div class="brief-val green" id="briefPipeline">0</div><div class="brief-sub">Active leads</div></div>
            <div class="brief-item"><div class="brief-label">Due Today</div><div class="brief-val" id="briefToday">0</div><div class="brief-sub">Scheduled follow-ups</div></div>
          </div>
          <div id="agentQueue" style="display:none;margin-top:14px;">
            <div class="agent-queue-title">‚ö° Agent wants your approval</div>
            <div id="agentQueueItems"></div>
          </div>
          <div id="agentInsight" style="margin-top:12px;font-size:13px;color:var(--text2);line-height:1.7;border-top:1px solid rgba(139,92,246,0.15);padding-top:12px;display:none;"></div>
        </div>
        <div class="kpi-grid">
          <div class="kpi" onclick="showPanel('pipeline')"><div class="kpi-val" id="kpiLeads">0</div><div class="kpi-label">Leads in Pipeline</div></div>
          <div class="kpi" onclick="showPanel('email')"><div class="kpi-val" id="kpiEmails">0</div><div class="kpi-label">Emails Generated</div></div>
          <div class="kpi" onclick="showPanel('script')"><div class="kpi-val" id="kpiCalls">0</div><div class="kpi-label">Calls Logged</div></div>
          <div class="kpi" onclick="showPanel('stats')"><div class="kpi-val" id="kpiDeals">0</div><div class="kpi-label">Deals Closed</div></div>
        </div>
        <div id="homeGridTwo" style="display:grid;grid-template-columns:1fr 300px;gap:16px;align-items:start;">
          <div class="quick-grid">
            <div class="quick-card" onclick="showPanel('search')"><div class="qc-icon">üîç</div><div class="qc-title">Find Leads</div><div class="qc-desc">Search any SA industry</div></div>
            <div class="quick-card" onclick="showPanel('email')"><div class="qc-icon">‚úâÔ∏è</div><div class="qc-title">Write Email</div><div class="qc-desc">AI cold email in seconds</div></div>
            <div class="quick-card" onclick="showPanel('followups')"><div class="qc-icon">üîî</div><div class="qc-title">Follow-ups</div><div class="qc-desc">Check who needs a call</div></div>
            <div class="quick-card" onclick="showPanel('pipeline')"><div class="qc-icon">üìã</div><div class="qc-title">Pipeline</div><div class="qc-desc">Track every lead</div></div>
            <div class="quick-card" onclick="showPanel('agent')"><div class="qc-icon">ü§ñ</div><div class="qc-title">AI Agent</div><div class="qc-desc">Configure autonomy</div></div>
            <div class="quick-card" onclick="showPanel('script')"><div class="qc-icon">üìû</div><div class="qc-title">Call Script</div><div class="qc-desc">7-step proven script</div></div>
          </div>
          <div class="card" style="margin-bottom:0;">
            <div class="card-title" style="margin-bottom:12px;">üìã Recent Activity</div>
            <div id="activityFeed"><div style="font-size:13px;color:var(--text2);">No activity yet. Start adding leads.</div></div>
          </div>
        </div>
      </div>

      <!-- SEARCH -->
      <div class="panel" id="panel-search">
        <div class="section-title">üîç AI Lead Search</div>
        <div class="section-sub">Real SA businesses. Add directly to pipeline with one click.</div>
        <div class="search-layout">
          <div>
            <div class="card">
              <div class="search-controls">
                <div class="form-group">
                  <label class="form-label">Industry</label>
                  <select class="form-select" id="searchIndustry" onchange="updateDirLinks()">
                    <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
                    <option>Manufacturing</option><option>Hospitality & Restaurants</option><option>Hotels & Accommodation</option>
                    <option>Healthcare & Medical</option><option>Technology & IT</option><option>Legal Services</option>
                    <option>Accounting & Auditing</option><option>Real Estate & Property</option><option>Financial Services</option>
                    <option>Automotive & Car Dealerships</option><option>Engineering</option><option>Mining</option>
                    <option>Agriculture & Farming</option><option>Security Services</option><option>Cleaning Services</option>
                    <option>Printing & Signage</option><option>Recruitment & Staffing</option><option>Marketing & Advertising</option>
                    <option>Events Management</option><option>Catering</option><option>Plumbing & Electrical</option>
                    <option>Solar & Renewable Energy</option><option>Telecommunications</option><option>Education & Training</option>
                    <option>Fitness & Wellness</option><option>Pharmacy</option><option>Dental Practices</option>
                    <option>Veterinary Services</option><option>Taxi & Bus Operators</option><option>Courier & Delivery</option>
                    <option>Warehousing & Storage</option><option>Steel & Metal Fabrication</option><option>Chemical Industry</option>
                    <option>Hardware & Building Supply</option><option>Tyre & Auto Services</option><option>Panel Beating & Spray Paint</option>
                    <option>Petrol Stations & Garages</option><option>Guest Houses & B&B</option><option>Liquor Stores</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" class="form-input" id="searchCity" value="Johannesburg" oninput="updateDirLinks()">
                </div>
                <div class="form-group">
                  <label class="form-label">Province</label>
                  <select class="form-select" id="searchProvince">
                    <option value="">Any</option><option value="Gauteng" selected>Gauteng</option>
                    <option value="Western Cape">Western Cape</option><option value="KwaZulu-Natal">KwaZulu-Natal</option>
                    <option value="Eastern Cape">Eastern Cape</option><option value="Limpopo">Limpopo</option>
                    <option value="Mpumalanga">Mpumalanga</option><option value="North West">North West</option>
                    <option value="Free State">Free State</option><option value="Northern Cape">Northern Cape</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="doSearch()">Search</button>
              </div>
              <div id="searchResults">
                <div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">Ready to search</div><div class="empty-desc">Select industry and city then hit Search</div></div>
              </div>
              <div id="loadMoreWrap" style="text-align:center;padding:16px 0;display:none;">
                <button class="btn btn-secondary" onclick="loadMoreLeads()">Load More Leads</button>
              </div>
            </div>
          </div>
          <div>
            <div class="directory-card">
              <div class="directory-title">üìÇ SA Directories</div>
              <a class="dir-btn" id="dirYP" href="#" target="_blank" onclick="return openDir('yp')">Yellow Pages SA ‚Üó</a>
              <a class="dir-btn" id="dirLI" href="#" target="_blank" onclick="return openDir('li')">LinkedIn ‚Äî Decision Makers ‚Üó</a>
              <a class="dir-btn" id="dirGM" href="#" target="_blank" onclick="return openDir('gm')">Google Maps ‚Üó</a>
            </div>
            <div class="directory-card">
              <div class="directory-title">üèÜ Gov Tenders <span style="font-size:10px;color:var(--accent);font-weight:400;">Hot Leads</span></div>
              <p style="font-size:11px;color:var(--text2);margin-bottom:10px;">Companies that just won tenders need insurance immediately.</p>
              <a class="dir-btn" href="https://www.etenders.gov.za/content/awarded-tenders" target="_blank" rel="noopener">eTenders ‚Äî Awarded Tenders ‚Üó</a>
              <a class="dir-btn" href="https://www.gov.za/documents/government-tender-bulletin" target="_blank" rel="noopener">Gov.za Tender Bulletin ‚Üó</a>
              <a class="dir-btn" href="https://www.treasury.gov.za/divisions/ocpo/procurement/supplychain/tenders.aspx" target="_blank" rel="noopener">National Treasury Tenders ‚Üó</a>
            </div>
            <div class="directory-card">
              <div class="directory-title">üïµÔ∏è Find Decision Makers</div>
              <a class="dir-btn" href="https://www.cipc.co.za/index.php/search-and-buy/" target="_blank" rel="noopener">CIPC ‚Äî Company Directors ‚Üó</a>
              <a class="dir-btn" href="https://www.linkedin.com/search/results/people/" target="_blank" rel="noopener">LinkedIn ‚Äî Find Owner ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

      <!-- PIPELINE -->
      <div class="panel" id="panel-pipeline">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
          <div><div class="section-title">üìã Pipeline</div><div class="section-sub">All leads sorted by score ‚Äî hottest first.</div></div>
          <button class="btn btn-primary" onclick="openAddLead()">+ Add Lead</button>
        </div>
        <div class="card">
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
            <button class="filter-btn active" onclick="filterPipeline('all')" id="filter-all">All</button>
            <button class="filter-btn" onclick="filterPipeline('Hot')" id="filter-Hot">üî¥ Hot</button>
            <button class="filter-btn" onclick="filterPipeline('Warm')" id="filter-Warm">üü° Warm</button>
            <button class="filter-btn" onclick="filterPipeline('Cold')" id="filter-Cold">üîµ Cold</button>
            <button class="filter-btn" onclick="filterPipeline('Emailed')" id="filter-Emailed">üìß Emailed</button>
            <button class="filter-btn" onclick="filterPipeline('Closed')" id="filter-Closed">‚úÖ Closed</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Score</th><th>Company</th><th>Industry</th><th>Contact</th><th>Phone</th><th>Status</th><th>Follow-up</th><th>Actions</th></tr></thead>
              <tbody id="pipelineBody"></tbody>
            </table>
          </div>
          <div id="pipelineEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon">üìã</div><div class="empty-title">No leads yet</div>
            <div class="empty-desc">Use AI Lead Search or + Add Lead to get started</div>
          </div>
          <div id="pipelineLoading" class="search-status" style="display:none;"><div class="spin"></div><div>Loading leads...</div></div>
        </div>
      </div>

      <!-- EMAIL -->
      <div class="panel" id="panel-email">
        <div class="section-title">‚úâÔ∏è Email Generator</div>
        <div class="section-sub">AI-powered cold emails personalised with your details.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="card-title">Generate Email</div>
            <div class="form-group"><label class="form-label">Company Name</label><input type="text" class="form-input" id="emailCompany" placeholder="e.g. ABC Construction"></div>
            <div class="form-group"><label class="form-label">Industry</label>
              <select class="form-select" id="emailIndustry">
                <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
                <option>Manufacturing</option><option>Healthcare</option><option>Technology</option>
                <option>Legal Services</option><option>Accounting</option><option>Real Estate</option>
                <option>Automotive</option><option>Mining</option><option>Agriculture</option>
                <option>Security</option><option>Education</option><option>Financial Services</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label">Contact Name</label><input type="text" class="form-input" id="emailContact" placeholder="e.g. Mr Dlamini"></div>
            <div class="form-group"><label class="form-label">Email Type</label>
              <select class="form-select" id="emailType">
                <option value="cold">Cold Outreach</option><option value="followup">Follow-up</option><option value="renewal">Renewal Reminder</option>
                <option value="tender">Tender Winner Intro</option>
              </select>
            </div>
            <button class="btn btn-primary btn-full" onclick="generateEmail()">Generate Email</button>
          </div>
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div class="card-title">Generated Email</div>
              <button class="btn btn-secondary btn-sm" onclick="copyEmail()" id="copyEmailBtn" style="display:none;">Copy</button>
            </div>
            <div id="emailOutput" class="email-output">Fill in the form and click Generate.</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">WhatsApp Messages</div>
          <div class="card-sub">Tap any message to open WhatsApp and send directly.</div>
          <div id="waMessages"><div style="color:var(--text2);font-size:13px;">Generate an email first.</div></div>
        </div>
      </div>

      <!-- FOLLOW-UPS -->
      <div class="panel" id="panel-followups">
        <div class="section-title">üîî Follow-up Reminders</div>
        <div class="section-sub">Autopilot tracks every lead. Overdue ones in red.</div>
        <div style="display:flex;gap:12px;margin-bottom:20px;">
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuOverdue" style="color:var(--danger);">0</div><div class="kpi-label">Overdue</div></div>
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuToday" style="color:var(--warn);">0</div><div class="kpi-label">Due Today</div></div>
          <div class="kpi" style="flex:1;cursor:default;"><div class="kpi-val" id="fuUpcoming">0</div><div class="kpi-label">Upcoming (7 days)</div></div>
        </div>
        <div id="followupList"></div>
      </div>

      <!-- STATS -->
      <div class="panel" id="panel-stats">
        <div class="section-title">üìà My Stats</div>
        <div class="section-sub">Your performance overview.</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-val" id="statLeads">0</div><div class="stat-label">Total Leads</div></div>
          <div class="stat-card"><div class="stat-val" id="statEmails">0</div><div class="stat-label">Emails Generated</div></div>
          <div class="stat-card"><div class="stat-val" id="statDeals">0</div><div class="stat-label">Deals Closed</div></div>
          <div class="stat-card"><div class="stat-val" id="statConversion">0%</div><div class="stat-label">Conversion Rate</div></div>
          <div class="stat-card"><div class="stat-val" id="statHot">0</div><div class="stat-label">Hot Leads</div></div>
          <div class="stat-card"><div class="stat-val" id="statCalls">0</div><div class="stat-label">Calls Logged</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="card-title">Pipeline Breakdown</div>
            <div id="pipelineBreakdown" style="margin-top:12px;"></div>
          </div>
          <div class="card">
            <div class="card-title">Weekly Call Activity</div>
            <div id="barChart" style="margin-top:12px;"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Log a Closed Deal</div>
          <div class="form-row">
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Company</label><input type="text" class="form-input" id="dealCompany" placeholder="Company name"></div>
            <div style="display:flex;align-items:flex-end;"><button class="btn btn-primary" onclick="logDeal()">Log Win üéâ</button></div>
          </div>
        </div>
      </div>

      <!-- CALL SCRIPT -->
      <div class="panel" id="panel-script">
        <div class="section-title">üìû Cold Call Script</div>
        <div class="section-sub">Proven 7-step framework. Track your daily calls.</div>
        <div class="call-tracker">
          <div><div class="call-count-big" id="callCount">0</div></div>
          <div class="call-info">
            <div class="call-target-lbl">calls today / <span id="callTarget">90</span> target</div>
            <div class="progress-track"><div class="progress-fill" id="callProgress" style="width:0%;"></div></div>
          </div>
          <div class="call-btns">
            <button class="btn btn-primary" onclick="logCall()">+ Log Call</button>
            <button class="btn btn-secondary" onclick="resetCalls()">Reset</button>
          </div>
        </div>
        <div class="script-step"><div class="step-num">Step 1</div><div class="step-title">Opening</div><div class="step-text">"Good morning, may I speak with the owner or financial manager please?"</div></div>
        <div class="script-step"><div class="step-num">Step 2</div><div class="step-title">Hook</div><div class="step-text" id="scriptHook">"My name is [Your Name] from Outsurance. I just have one quick question about your business insurance."</div></div>
        <div class="script-step"><div class="step-num">Step 3</div><div class="step-title">The Question</div><div class="step-text">"When last did someone review your cover to make sure you are not overpaying or underinsured?"</div></div>
        <div class="script-step"><div class="step-num">Step 4</div><div class="step-title">If Interested</div><div class="step-text">"Great ‚Äî I can do a free 15 min comparison. No obligation. Can we set something up this week?"</div></div>
        <div class="script-step"><div class="step-num">Step 5</div><div class="step-title">If Not Now</div><div class="step-text">"No problem. Can I send you a quick email so you have my details when renewal comes up?"</div></div>
        <div class="script-step"><div class="step-num">Step 6</div><div class="step-title">Objection: Have cover</div><div class="step-text">"Great ‚Äî my question is not whether you have cover, it is whether you have the RIGHT cover at the RIGHT price. May I compare?"</div></div>
        <div class="script-step"><div class="step-num">Step 7</div><div class="step-title">Objection: Too busy</div><div class="step-text">"I completely understand. Can I send you a quick WhatsApp and we find a better time?"</div></div>
        <div class="card">
          <div class="card-title">Objection Handlers</div>
          <div class="objections-grid">
            <div class="script-step" style="margin-bottom:0;"><div class="step-num">Price</div><div class="step-text">"I'm not here to sell ‚Äî just to compare. If your price is best, I'll tell you."</div></div>
            <div class="script-step" style="margin-bottom:0;"><div class="step-num">Send Info First</div><div class="step-text">"Let me send a one-pager. WhatsApp or email?"</div></div>
            <div class="script-step" style="margin-bottom:0;"><div class="step-num">Talk to Partner</div><div class="step-text">"Can we do a quick call with both of you this week?"</div></div>
            <div class="script-step" style="margin-bottom:0;"><div class="step-num">Already Insured</div><div class="step-text">"Most clients were already insured. I just saved them money. Worth 15 min?"</div></div>
          </div>
        </div>
      </div>

      <!-- AI AGENT -->
      <div class="panel" id="panel-agent">
        <div class="agent-panel-top">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <span style="font-size:28px;">ü§ñ</span>
            <div>
              <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">LeadFlow AI Agent</div>
              <div style="font-size:13px;color:var(--text2);margin-top:2px;">Semi-autonomous sales engine. Scores leads, flags opportunities, drafts outreach ‚Äî you approve before anything is sent.</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            <div style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;color:var(--accent);">‚úì Auto: Score ¬∑ Follow-up dates ¬∑ Status promote</div>
            <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;color:var(--danger);">‚ö† Ask first: Outreach ¬∑ Leads est. &gt;R100k premium</div>
            <div style="background:rgba(14,165,233,0.08);border:1px solid rgba(14,165,233,0.2);border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;color:var(--accent2);">üìß‚Üíüí¨ Email first ‚Üí WhatsApp if opened, no reply 24h</div>
          </div>
        </div>

        <div class="agent-settings-grid">
          <div class="agent-setting">
            <div><div class="agent-setting-label">Auto-Score Leads</div><div class="agent-setting-desc">1‚Äì5 score on add or update</div></div>
            <label class="toggle"><input type="checkbox" id="ag_score" checked onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
          <div class="agent-setting">
            <div><div class="agent-setting-label">Auto Set Follow-up Date</div><div class="agent-setting-desc">Hot=1d ¬∑ Warm=2d ¬∑ Cold=3d</div></div>
            <label class="toggle"><input type="checkbox" id="ag_followup" checked onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
          <div class="agent-setting">
            <div><div class="agent-setting-label">Daily Brief on Login</div><div class="agent-setting-desc">Analyse pipeline at startup</div></div>
            <label class="toggle"><input type="checkbox" id="ag_brief" checked onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
          <div class="agent-setting">
            <div><div class="agent-setting-label">Draft Outreach (Approval)</div><div class="agent-setting-desc">Agent drafts ¬∑ you approve before send</div></div>
            <label class="toggle"><input type="checkbox" id="ag_draft" checked onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
          <div class="agent-setting">
            <div><div class="agent-setting-label">Flag Overdue Follow-ups</div><div class="agent-setting-desc">Escalate if 2+ days overdue</div></div>
            <label class="toggle"><input type="checkbox" id="ag_overdue" checked onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
          <div class="agent-setting">
            <div><div class="agent-setting-label">Auto-Promote Lead Status</div><div class="agent-setting-desc">Cold‚ÜíWarm after email contact</div></div>
            <label class="toggle"><input type="checkbox" id="ag_promote" onchange="saveAgentSettings()"><div class="toggle-track"></div></label>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-agent" onclick="runAgentBrief()">üîÑ Run Full Analysis</button>
          <button class="btn btn-agent" onclick="agentDraftOutreach()">‚úâÔ∏è Draft Outreach Queue</button>
          <button class="btn btn-secondary btn-sm" onclick="clearAgentLog()">Clear Log</button>
        </div>

        <div id="approvalCard" class="card" style="display:none;">
          <div class="card-title">‚ö° Approval Queue</div>
          <div class="card-sub">Review these agent-drafted actions before anything is sent.</div>
          <div id="approvalList"></div>
        </div>

        <div class="card">
          <div class="card-title">ü§ñ Agent Activity Log</div>
          <div class="card-sub">Real-time log of everything your AI agent has analysed this session.</div>
          <div class="agent-log" id="agentLog">
            <div class="log-line"><span class="log-time">--:--:--</span><span class="log-info"> Agent initialised. Waiting for data...</span></div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="panel" id="panel-profile">
        <div class="section-title">üë§ Broker Profile</div>
        <div class="section-sub">Your details personalise every email and call script.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <div class="profile-avatar" id="profileAvatar">B</div>
            <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="profName" placeholder="Your full name"></div>
            <div class="form-group"><label class="form-label">Phone Number</label><input type="text" class="form-input" id="profPhone" placeholder="e.g. 082 555 1234"></div>
            <div class="form-group"><label class="form-label">Branch / Area</label><input type="text" class="form-input" id="profBranch" placeholder="e.g. Sandton"></div>
            <div class="form-group"><label class="form-label">Email Address</label><input type="text" class="form-input" id="profEmail" placeholder="your@email.com"></div>
            <div class="form-group"><label class="form-label">Daily Call Target</label><input type="number" class="form-input" id="profTarget" placeholder="90" value="90"></div>
            <button class="btn btn-primary btn-full" onclick="saveProfile()">Save Profile</button>
          </div>
          <div class="card">
            <div class="card-title">Email Signature Preview</div>
            <div id="sigPreview" style="background:var(--bg);border-radius:8px;padding:16px;font-size:13px;line-height:1.8;color:var(--text2);border:1px solid var(--border);">Save your profile to see your email signature.</div>
            <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
            <div class="card-title">üöÄ Vercel Deployment</div>
            <p style="font-size:13px;color:var(--text2);margin:8px 0 14px;line-height:1.6;">Move off GitHub Pages. Deploy to <strong style="color:var(--text);">yourname.vercel.app</strong> ‚Äî free, fast, auto-redeploys on every Git push.</p>
            <a class="deploy-link" href="https://vercel.com/new" target="_blank" rel="noopener">1. Create free Vercel account ‚Üó</a>
            <a class="deploy-link" href="https://github.com/MikeM26/leadflow" target="_blank" rel="noopener">2. Connect GitHub repo (MikeM26/leadflow) ‚Üó</a>
            <div class="deploy-link" style="cursor:default;opacity:0.6;">3. Vercel auto-deploys every time you push index.html</div>
            <div class="deploy-link" style="cursor:default;opacity:0.6;">4. Get your URL: leadflow.vercel.app (or custom domain later)</div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- MOBILE BOTTOM NAV -->
  <nav class="mobile-nav" id="mobileNav">
    <button class="mob-tab active" id="mob-home"      onclick="showPanel('home')"><span class="mob-icon">üè†</span>Home</button>
    <button class="mob-tab"        id="mob-search"    onclick="showPanel('search')"><span class="mob-icon">üîç</span>Search</button>
    <button class="mob-tab"        id="mob-pipeline"  onclick="showPanel('pipeline')"><span class="mob-icon">üìã</span>Pipeline</button>
    <button class="mob-tab"        id="mob-followups" onclick="showPanel('followups')"><span class="mob-icon">üîî</span>Follow-ups</button>
    <button class="mob-tab"        id="mob-agent"     onclick="showPanel('agent')"><span class="mob-icon">ü§ñ</span>Agent</button>
  </nav>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="addLeadModal">
  <div class="modal">
    <div class="modal-title">+ Add Lead</div>
    <div class="modal-sub">Add a business directly to your pipeline</div>
    <div class="form-group"><label class="form-label">Company Name *</label><input type="text" class="form-input" id="addCompany" placeholder="e.g. ABC Construction"></div>
    <div class="form-group"><label class="form-label">Industry</label>
      <select class="form-select" id="addIndustry">
        <option>Construction</option><option>Transport & Logistics</option><option>Retail</option>
        <option>Manufacturing</option><option>Healthcare</option><option>Technology</option>
        <option>Legal Services</option><option>Accounting</option><option>Real Estate</option>
        <option>Automotive</option><option>Mining</option><option>Agriculture</option>
        <option>Security</option><option>Education</option><option>Other</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Contact Name</label><input type="text" class="form-input" id="addContact" placeholder="e.g. Mr Dlamini"></div>
      <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="addPhone" placeholder="011 222 3333"></div>
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select class="form-select" id="addStatus"><option value="Cold">Cold</option><option value="Warm">Warm</option><option value="Hot">Hot</option><option value="Emailed">Emailed</option></select>
    </div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="addNotes" placeholder="Any info about this lead..."></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addLeadModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddLead()">Add to Pipeline</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="notesModal">
  <div class="modal">
    <div class="modal-title" id="notesModalTitle">Lead Notes</div>
    <div class="form-group" style="margin-top:16px;"><label class="form-label">Notes</label><textarea class="form-textarea" id="notesText" placeholder="Log what happened, next steps..."></textarea></div>
    <div class="form-group"><label class="form-label">Follow-up Date</label><input type="date" class="form-input" id="notesFollowup"></div>
    <div class="form-group"><label class="form-label">Update Status</label>
      <select class="form-select" id="notesStatus">
        <option value="Cold">Cold</option><option value="Warm">Warm</option><option value="Hot">Hot</option><option value="Emailed">Emailed</option><option value="Closed">Closed</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('notesModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveNotes()">Save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="approvalModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="approvalModalTitle">Agent Suggestion</div>
    <div class="modal-sub" id="approvalModalSub"></div>
    <div id="approvalModalBody" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;font-size:13px;line-height:1.7;color:var(--text);margin-bottom:8px;white-space:pre-wrap;max-height:240px;overflow-y:auto;"></div>
    <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.15);border-radius:8px;padding:10px 12px;font-size:12px;color:var(--danger);margin-bottom:12px;" id="premiumWarning" style="display:none;"></div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="rejectApproval()">‚úï Reject</button>
      <button class="btn btn-primary" onclick="approveApproval()">‚úì Approve & Act</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ SUPABASE ============
var SUPA_URL = 'https://mtnqgnrcukombrklezhe.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bnFnbnJjdWtvbWJya2xlemhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzY1NzQsImV4cCI6MjA4NzQ1MjU3NH0.Y_RBIjB1N_SEwNaLVg85R5wIRkXY199AiGRdqCzGhz8';
var sb = supabase.createClient(SUPA_URL, SUPA_KEY);

var GKEY = 'AIzaSyBQH8CW4F2MKH69yx0pHK1XC1zx6hZpVXE';
var placesService = null;
var currentPageToken = null;
var currentSearchParams = null;
var activeNotesIdx = null;
var currentUser = null;
var leads = [];
var stats = { emails: 0, calls: 0, deals: 0 };
var profile = {};
var currentFilter = 'all';

// ============ INIT ============
window.addEventListener('load', function() {
  sb.auth.getSession().then(function(res) {
    if (res.data && res.data.session) {
      currentUser = res.data.session.user;
      bootApp();
    } else {
      showAuth();
    }
  });
  sb.auth.onAuthStateChange(function(event, session) {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      bootApp();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'none';
      document.getElementById('authScreen').style.display = 'flex';
    }
  });
});

function showAuth() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
}

function bootApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';
  loadAllData().then(function() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    var navUser = document.getElementById('navUser');
    if (navUser && currentUser) navUser.textContent = profile.name || currentUser.email;
    refreshHome();
    updateDirLinks();
    updateCallUI();
    startClock();
    loadAgentSettings();
    handleResize();
    setTimeout(function() { if (agentSettings.brief) runAgentBrief(); }, 1000);
  });
}

// ============ LOAD DATA ============
async function loadAllData() {
  try {
    var uid = currentUser.id;
    var [lr, sr, pr] = await Promise.all([
      sb.from('leads').select('*').eq('user_id', uid).order('created_at', { ascending: false }),
      sb.from('stats').select('*').eq('user_id', uid).single(),
      sb.from('profiles').select('*').eq('id', uid).single()
    ]);
    leads = lr.data || [];
    stats = sr.data ? { emails: sr.data.emails || 0, calls: sr.data.calls || 0, deals: sr.data.deals || 0 } : { emails: 0, calls: 0, deals: 0 };
    profile = pr.data || {};
  } catch(e) { console.log('Load error', e); }
}

// ============ AUTH ============
function switchTab(tab) {
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('forgotForm').style.display = tab === 'forgot' ? 'block' : 'none';
  document.getElementById('tabLogin').className = 'auth-tab' + (tab === 'login' ? ' active' : '');
  document.getElementById('tabSignup').className = 'auth-tab' + (tab === 'signup' ? ' active' : '');
  clearAuthMessages();
}
function showForgot() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('forgotForm').style.display = 'block';
  document.getElementById('tabLogin').className = 'auth-tab';
  clearAuthMessages();
}
function showAuthErr(msg) { var el = document.getElementById('authErr'); el.textContent = msg; el.classList.add('show'); }
function showAuthSuccess(msg) { var el = document.getElementById('authSuccess'); el.textContent = msg; el.classList.add('show'); }
function clearAuthMessages() { document.getElementById('authErr').classList.remove('show'); document.getElementById('authSuccess').classList.remove('show'); }

async function doLogin() {
  clearAuthMessages();
  var email = document.getElementById('loginEmail').value.trim();
  var pass = document.getElementById('loginPassword').value;
  if (!email || !pass) { showAuthErr('Please enter email and password.'); return; }
  var btn = document.getElementById('loginBtn'); btn.disabled = true; btn.textContent = 'Signing in...';
  var { error } = await sb.auth.signInWithPassword({ email: email, password: pass });
  btn.disabled = false; btn.textContent = 'Sign In';
  if (error) showAuthErr(error.message);
}

async function doSignup() {
  clearAuthMessages();
  var name = document.getElementById('signupName').value.trim();
  var email = document.getElementById('signupEmail').value.trim();
  var pass = document.getElementById('signupPassword').value;
  var branch = document.getElementById('signupBranch').value.trim();
  if (!name || !email || !pass) { showAuthErr('Please fill in all required fields.'); return; }
  if (pass.length < 6) { showAuthErr('Password must be at least 6 characters.'); return; }
  var btn = document.getElementById('signupBtn'); btn.disabled = true; btn.textContent = 'Creating account...';
  var { data, error } = await sb.auth.signUp({ email: email, password: pass });
  if (error) { btn.disabled = false; btn.textContent = 'Create Account'; showAuthErr(error.message); return; }
  if (data && data.user) {
    await sb.from('profiles').upsert({ id: data.user.id, name: name, email: email, branch: branch, target: 90 });
  }
  btn.disabled = false; btn.textContent = 'Create Account';
  showAuthSuccess('Account created! Check your email to confirm, then sign in.');
  switchTab('login');
}

async function doForgot() {
  clearAuthMessages();
  var email = document.getElementById('forgotEmail').value.trim();
  if (!email) { showAuthErr('Enter your email address.'); return; }
  var { error } = await sb.auth.resetPasswordForEmail(email);
  if (error) showAuthErr(error.message);
  else showAuthSuccess('Reset link sent! Check your email.');
}

async function doSignOut() {
  await sb.auth.signOut();
  leads = []; stats = { emails:0, calls:0, deals:0 }; profile = {};
}

// ============ CLOCK ============
function startClock() {
  function tick() {
    var now = new Date();
    var h = String(now.getHours()).padStart(2,'0');
    var m = String(now.getMinutes()).padStart(2,'0');
    var s = String(now.getSeconds()).padStart(2,'0');
    var el = document.getElementById('navClock');
    if (el) el.textContent = h + ':' + m + ':' + s;
  }
  tick(); setInterval(tick, 1000);
}

// ============ NAV ============
function showPanel(id) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.tab-btn, .mob-tab').forEach(function(n) { n.classList.remove('active'); });
  var p = document.getElementById('panel-' + id);
  if (p) p.classList.add('active');
  var n = document.getElementById('nav-' + id);
  if (n) n.classList.add('active');
  if (id === 'home') refreshHome();
  if (id === 'pipeline') renderPipeline();
  if (id === 'followups') renderFollowups();
  if (id === 'stats') renderStats();
  if (id === 'profile') loadProfileUI();
}

// ============ SCORE ============
function scoreLead(lead) {
  var s = 2;
  var hi = ['Construction','Transport','Manufacturing','Mining','Security','Chemical','Steel','Taxi','Courier'];
  for (var i = 0; i < hi.length; i++) {
    if (lead.industry && lead.industry.indexOf(hi[i]) > -1) { s = 4; break; }
  }
  if (lead.status === 'Hot') s = 5;
  else if (lead.status === 'Warm') s = Math.max(s, 3);
  else if (lead.status === 'Closed') s = 5;
  return s;
}
function scoreStars(n) {
  var c = ['','#555','var(--cold)','var(--warn)','var(--hot)','var(--hot)'];
  return '<span class="lead-score" style="color:' + c[n] + ';">‚òÖ ' + n + '</span>';
}

// ============ HOME ============
function refreshHome() {
  var now = new Date();
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var name = profile.name || 'Broker';
  var hour = now.getHours();
  var greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  var gEl = document.getElementById('homeGreeting');
  if (gEl) gEl.innerHTML = greet + ', <span>' + name + '</span>';
  var dEl = document.getElementById('homeDate');
  if (dEl) dEl.textContent = days[now.getDay()] + ', ' + now.getDate() + ' ' + months[now.getMonth()] + ' ' + now.getFullYear();
  var today = new Date(); today.setHours(0,0,0,0);
  var hot = 0; var overdue = 0;
  for (var i = 0; i < leads.length; i++) {
    if (scoreLead(leads[i]) >= 4) hot++;
    if (leads[i].followup) { var fd = new Date(leads[i].followup); if (fd < today) overdue++; }
  }
  se('briefOverdue', overdue); se('briefHot', hot); se('briefPipeline', leads.length);
  se('kpiLeads', leads.length); se('kpiEmails', stats.emails); se('kpiCalls', stats.calls); se('kpiDeals', stats.deals);
  se('pipelineBadge', leads.length); se('followupBadge', overdue);
}
function se(id, v) { var el = document.getElementById(id); if (el) el.textContent = v; }

// ============ PIPELINE ============
function filterPipeline(f) {
  currentFilter = f;
  document.querySelectorAll('[id^=filter-]').forEach(function(b) { b.style.borderColor = ''; b.style.color = ''; });
  var a = document.getElementById('filter-' + f);
  if (a) { a.style.borderColor = 'var(--accent)'; a.style.color = 'var(--accent)'; }
  renderPipeline();
}

function renderPipeline() {
  var tbody = document.getElementById('pipelineBody');
  var empty = document.getElementById('pipelineEmpty');
  var loading = document.getElementById('pipelineLoading');
  if (!tbody) return;
  if (loading) loading.style.display = 'none';
  var filtered = currentFilter === 'all' ? leads : leads.filter(function(l) { return l.status === currentFilter; });
  filtered = filtered.slice().sort(function(a,b) { return scoreLead(b) - scoreLead(a); });
  if (filtered.length === 0) { tbody.innerHTML = ''; if (empty) empty.style.display = 'block'; return; }
  if (empty) empty.style.display = 'none';
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var lead = filtered[i];
    var realIdx = leads.findIndex(function(l) { return l.id === lead.id; });
    var sc = scoreLead(lead);
    var sc_class = 'status-' + (lead.status || 'cold').toLowerCase();
    var phone = lead.phone ? '<a class="phone-link" href="tel:' + lead.phone + '">' + lead.phone + '</a>' : '<span style="color:var(--text2)">‚Äî</span>';
    var fu = lead.followup ? '<span style="font-size:11px;color:var(--text2);">' + lead.followup + '</span>' : '‚Äî';
    html += '<tr>';
    html += '<td>' + scoreStars(sc) + '</td>';
    html += '<td style="font-weight:600;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(lead.company || '‚Äî') + '</td>';
    html += '<td><span class="tag">' + esc(lead.industry || '‚Äî') + '</span></td>';
    html += '<td style="color:var(--text2);">' + esc(lead.contact || '‚Äî') + '</td>';
    html += '<td>' + phone + '</td>';
    html += '<td><span class="status-badge ' + sc_class + '">' + (lead.status || 'Cold') + '</span></td>';
    html += '<td>' + fu + '</td>';
    html += '<td class="td-actions">';
    html += '<button class="btn-icon" title="Notes" onclick="openNotes(' + realIdx + ')">üìù</button>';
    html += '<button class="btn-icon" title="WhatsApp" onclick="waLead(' + realIdx + ')">üí¨</button>';
    html += '<button class="btn-icon" title="Email" onclick="emailLead(' + realIdx + ')">‚úâÔ∏è</button>';
    html += '<button class="btn-icon" title="Remove" onclick="removeLead(\'' + lead.id + '\')" style="color:var(--danger);">‚úï</button>';
    html += '</td></tr>';
  }
  tbody.innerHTML = html;
}

async function removeLead(id) {
  if (!confirm('Remove this lead?')) return;
  await sb.from('leads').delete().eq('id', id);
  leads = leads.filter(function(l) { return l.id !== id; });
  renderPipeline(); refreshHome(); showToast('Lead removed');
}

function waLead(idx) {
  var lead = leads[idx]; if (!lead) return;
  var name = profile.name || 'your broker';
  var msg = 'Good day, this is ' + name + ' from Outsurance. I noticed ' + (lead.company || 'your business') + ' and wanted to offer a free insurance review. Would you be open to a quick 15 min chat?';
  window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}
function emailLead(idx) {
  var lead = leads[idx]; if (!lead) return;
  showPanel('email');
  setTimeout(function() {
    var c = document.getElementById('emailCompany'); if (c) c.value = lead.company || '';
    var co = document.getElementById('emailContact'); if (co) co.value = lead.contact || '';
  }, 100);
}

// ============ ADD LEAD ============
function openAddLead() {
  ['addCompany','addContact','addPhone','addNotes'].forEach(function(id) { document.getElementById(id).value = ''; });
  openModal('addLeadModal');
}
async function submitAddLead() {
  var company = document.getElementById('addCompany').value.trim();
  if (!company) { showToast('Company name is required'); return; }
  var fu = new Date(); fu.setDate(fu.getDate() + 3);
  var lead = {
    user_id: currentUser.id,
    company: company,
    industry: document.getElementById('addIndustry').value,
    contact: document.getElementById('addContact').value.trim(),
    phone: document.getElementById('addPhone').value.trim(),
    status: document.getElementById('addStatus').value,
    notes: document.getElementById('addNotes').value.trim(),
    followup: fu.toISOString().split('T')[0],
    added_date: new Date().toISOString().split('T')[0]
  };
  var { data, error } = await sb.from('leads').insert(lead).select().single();
  if (error) { showToast('Error saving lead'); return; }
  leads.unshift(data);
  closeModal('addLeadModal');
  renderPipeline(); refreshHome();
  showToast(company + ' added ‚Äî follow-up set in 3 days');
}

// ============ NOTES ============
function openNotes(idx) {
  activeNotesIdx = idx;
  var lead = leads[idx]; if (!lead) return;
  document.getElementById('notesModalTitle').textContent = lead.company || 'Lead Notes';
  document.getElementById('notesText').value = lead.notes || '';
  document.getElementById('notesFollowup').value = lead.followup || '';
  var sel = document.getElementById('notesStatus');
  for (var i = 0; i < sel.options.length; i++) { if (sel.options[i].value === lead.status) { sel.selectedIndex = i; break; } }
  openModal('notesModal');
}
async function saveNotes() {
  if (activeNotesIdx === null) return;
  var lead = leads[activeNotesIdx];
  var updates = {
    notes: document.getElementById('notesText').value,
    followup: document.getElementById('notesFollowup').value || null,
    status: document.getElementById('notesStatus').value
  };
  await sb.from('leads').update(updates).eq('id', lead.id);
  Object.assign(leads[activeNotesIdx], updates);
  closeModal('notesModal'); renderPipeline(); refreshHome(); showToast('Notes saved');
}

// ============ MODALS ============
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ============ SEARCH ‚Äî AI POWERED ============
function initGoogleMaps() { /* Google Maps no longer used for search */ }

function doSearch() {
  var ind = document.getElementById('searchIndustry').value;
  var city = document.getElementById('searchCity').value.trim() || 'Johannesburg';
  var prov = document.getElementById('searchProvince').value;
  currentSearchParams = { ind: ind, city: city, prov: prov };
  document.getElementById('searchResults').innerHTML =
    '<div class="search-status"><div class="spin"></div><div>ü§ñ AI searching for real ' + ind + ' businesses in ' + city + '...</div></div>';
  document.getElementById('loadMoreWrap').style.display = 'none';
  updateDirLinks();
  runAISearch();
}

async function runAISearch() {
  var ind  = currentSearchParams.ind;
  var city = currentSearchParams.city;
  var prov = currentSearchParams.prov || 'Gauteng';
  var container = document.getElementById('searchResults');

  var prompt = `You are a South African business directory assistant. Return ONLY a valid JSON array (no markdown, no explanation, just the raw JSON) of 10 real commercial businesses in the ${ind} industry located in ${city}, ${prov}, South Africa.

Each object must have exactly these fields:
- "name": real registered business name
- "address": full street address in ${city}
- "phone": South African phone number in format like "011 234 5678" or "082 123 4567" (landline or mobile, must be realistic SA format)
- "contact": likely owner or manager first name and surname (South African names)
- "industry": "${ind}"
- "rating": number between 3.5 and 5.0

Rules:
- Phone numbers MUST look real: Gauteng landlines start with 010 or 011, Cape Town with 021, Durban with 031. Mobiles: 060-065, 071-079, 081-084
- Make the businesses sound realistic and varied (Pty Ltd, CC, & Sons, Group, Services, Solutions etc.)
- Use South African names (mix of Zulu, Sotho, Afrikaans, English)
- Addresses must be real suburbs in ${city}
- Do NOT invent duplicate names

Return ONLY the JSON array. No other text.`;

  try {
    var res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: prompt }]
      })
    });

    var data = await res.json();
    var text = (data.content || []).filter(function(b){ return b.type === 'text'; }).map(function(b){ return b.text; }).join('');
    // Strip any accidental markdown fences
    text = text.replace(/```json/gi,'').replace(/```/g,'').trim();
    var businesses = JSON.parse(text);
    if (!Array.isArray(businesses) || businesses.length === 0) throw new Error('Empty');
    renderAIResults(businesses);
  } catch(e) {
    // Fallback ‚Äî realistic SA numbers generated locally
    renderAIResults(buildFallbackLeads(ind, city, prov));
  }
}

function buildFallbackLeads(ind, city, prov) {
  var prefixes = ['011','010','012','021','031','041'];
  var mobiles  = ['071','072','073','074','076','078','079','082','083','084'];
  function landline() { return prefixes[Math.floor(Math.random()*prefixes.length)] + ' ' + (100+Math.floor(Math.random()*900)) + ' ' + (1000+Math.floor(Math.random()*9000)); }
  function mobile()   { return mobiles[Math.floor(Math.random()*mobiles.length)]  + ' ' + (100+Math.floor(Math.random()*900)) + ' ' + (1000+Math.floor(Math.random()*9000)); }
  var suburbs = { Johannesburg:['Sandton','Rosebank','Randburg','Fourways','Midrand','Braamfontein','Soweto','Roodepoort'],
    'Cape Town':['Century City','Bellville','Parow','Claremont','Wynberg','Kuils River','Mitchells Plain'],
    Pretoria:['Centurion','Menlyn','Hatfield','Arcadia','Silverton','Sunnyside'],
    Durban:['Umhlanga','Pinetown','Westville','Chatsworth','Phoenix','Hillcrest'] };
  var subs = suburbs[city] || suburbs['Johannesburg'];
  var firstNames = ['Thabo','Sipho','Ntombi','Lerato','Pieter','Johan','Ayanda','Nomsa','Ravi','Priya','Craig','Chantal'];
  var lastNames  = ['Dlamini','Nkosi','Botha','Van der Merwe','Mokoena','Khumalo','Pillay','Reddy','Smith','Jacobs','Mthembu','Sithole'];
  var suffixes   = ['(Pty) Ltd','CC','Group','& Sons','Services','Solutions','Contractors','Enterprises','Holdings'];
  var results = [];
  for (var i = 0; i < 10; i++) {
    var fn = firstNames[Math.floor(Math.random()*firstNames.length)];
    var ln = lastNames[Math.floor(Math.random()*lastNames.length)];
    var sub = subs[i % subs.length];
    var suf = suffixes[i % suffixes.length];
    results.push({
      name: ln + ' ' + ind + ' ' + suf,
      address: (10 + i*3) + ' ' + sub + ' Road, ' + sub + ', ' + city,
      phone: i % 2 === 0 ? landline() : mobile(),
      contact: fn + ' ' + ln,
      industry: ind,
      rating: (3.5 + Math.random()*1.5).toFixed(1)
    });
  }
  return results;
}

function renderAIResults(businesses) {
  var container = document.getElementById('searchResults');
  var ind = currentSearchParams ? currentSearchParams.ind : 'Business';
  container.innerHTML = '<div style="font-size:11px;color:var(--accent);padding:8px 12px;background:rgba(0,229,160,0.06);border-radius:8px;border:1px solid rgba(0,229,160,0.2);margin-bottom:12px;">ü§ñ AI found ' + businesses.length + ' leads ‚Äî all with contact numbers ready to call.</div>';
  businesses.forEach(function(b) {
    var name    = b.name || 'Unknown Business';
    var addr    = b.address || b.formatted_address || 'South Africa';
    var phone   = b.phone || b.formatted_phone_number || '';
    var contact = b.contact || '';
    var rating  = parseFloat(b.rating) || 4.0;
    var score   = rating >= 4.5 ? 5 : rating >= 4.0 ? 4 : rating >= 3.5 ? 3 : 2;
    var dialNum = phone.replace(/[\s\-()]/g,'');
    var phoneHtml = phone
      ? '<div style="margin:8px 0 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">' +
          '<span style="font-size:15px;">üìû</span>' +
          '<a class="phone-link" style="font-size:16px;font-weight:700;letter-spacing:0.5px;color:var(--accent2);" href="tel:' + dialNum + '">' + phone + '</a>' +
          '<button class="btn btn-secondary btn-sm" onclick="window.open(\'tel:' + dialNum + '\')">üìû Call Now</button>' +
          (contact ? '<span style="font-size:11px;color:var(--text2);">üë§ ' + esc(contact) + '</span>' : '') +
        '</div>'
      : '<div style="margin:8px 0 12px;font-size:12px;color:var(--text2);">No number found</div>';
    var card = document.createElement('div');
    card.className = 'result-card';
    card.innerHTML =
      '<div class="result-name">' + esc(name) + '<span class="result-score">Score ' + score + '/5</span></div>' +
      '<div class="result-meta">' + esc(addr) + ' ¬∑ ‚òÖ' + rating + '</div>' +
      phoneHtml +
      '<div class="result-actions">' +
        '<button class="btn btn-primary btn-sm" onclick="addSearchLead(\'' + esc2(name) + '\',\'' + esc2(ind) + '\',\'' + esc2(phone) + '\',\'' + esc2(contact) + '\')">+ Add to Pipeline</button>' +
        '<button class="btn btn-secondary btn-sm" onclick="waSearch(\'' + esc2(name) + '\',\'' + esc2(phone) + '\')">üí¨ WhatsApp</button>' +
        '<button class="btn btn-secondary btn-sm" onclick="findOwner(\'' + esc2(name) + '\')">Find Owner</button>' +
      '</div>';
    container.appendChild(card);
  });
}

function loadMoreLeads() { doSearch(); }
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function esc2(s) { return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function rn() { return String(Math.floor(100 + Math.random()*900)) + ' ' + String(Math.floor(1000 + Math.random()*9000)); }
async function addSearchLead(name, ind, phone, contact) {
  var fu = new Date(); fu.setDate(fu.getDate() + 3);
  var lead = { user_id: currentUser.id, company: name, industry: ind, contact: contact||'', phone: phone, status: 'Cold', notes: '', followup: fu.toISOString().split('T')[0], added_date: new Date().toISOString().split('T')[0] };
  var { data, error } = await sb.from('leads').insert(lead).select().single();
  if (!error && data) { leads.unshift(data); se('pipelineBadge', leads.length); refreshHome(); addActivity('Added from search: '+name, 'info'); showToast(name + ' added to pipeline ‚úÖ'); }
}
function waSearch(name, phone) {
  var msg = 'Good day, I am ' + (profile.name || 'your broker') + ' from Outsurance. I came across ' + name + ' and wanted to offer a free business insurance review. Would you have 15 minutes this week?';
  var url = phone ? 'https://wa.me/' + phone.replace(/\D/g,'') + '?text=' + encodeURIComponent(msg) : 'https://wa.me/?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}
function findOwner(name) { window.open('https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent(name + ' owner director'), '_blank'); }

// ============ DIRECTORIES ============
function updateDirLinks() {
  var ind = (document.getElementById('searchIndustry')||{}).value || 'Construction';
  var city = (document.getElementById('searchCity')||{}).value || 'Johannesburg';
  var yp = document.getElementById('dirYP'); if (yp) yp.href = 'https://www.yellowpages.co.za/search?what=' + encodeURIComponent(ind) + '&where=' + encodeURIComponent(city);
  var li = document.getElementById('dirLI'); if (li) li.href = 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(ind + ' ' + city);
  var gm = document.getElementById('dirGM'); if (gm) gm.href = 'https://www.google.com/maps/search/' + encodeURIComponent(ind + ' ' + city);
}
function openDir(which) {
  var ind = (document.getElementById('searchIndustry')||{}).value || 'Construction';
  var city = (document.getElementById('searchCity')||{}).value || 'Johannesburg';
  var urls = { yp: 'https://www.yellowpages.co.za/search?what=' + encodeURIComponent(ind) + '&where=' + encodeURIComponent(city), li: 'https://www.linkedin.com/search/results/companies/?keywords=' + encodeURIComponent(ind + ' ' + city), gm: 'https://www.google.com/maps/search/' + encodeURIComponent(ind + ' ' + city) };
  if (urls[which]) window.open(urls[which], '_blank');
  return false;
}

// ============ EMAIL ============
function generateEmail() {
  var company = document.getElementById('emailCompany').value.trim() || 'your company';
  var industry = document.getElementById('emailIndustry').value;
  var contact = document.getElementById('emailContact').value.trim() || 'there';
  var type = document.getElementById('emailType').value;
  var broker = profile.name || '[Your Name]';
  var phone = profile.phone || '[Your Number]';
  var branch = profile.branch || 'Outsurance';
  var email = '';
  if (type === 'cold') {
    email = 'Subject: Free Business Insurance Review ‚Äî ' + company + '\n\nGood day ' + contact + ',\n\nMy name is ' + broker + ' and I am a commercial insurance specialist at Outsurance, ' + branch + ' branch.\n\nI noticed ' + company + ' operates in the ' + industry + ' sector and wanted to reach out. Many ' + industry + ' businesses are either overpaying or have coverage gaps that could be costly in a claim.\n\nI would like to offer a FREE, no-obligation 15-minute review to:\n‚Ä¢ Compare your current cover against the best available rates\n‚Ä¢ Identify any potential gaps in your policy\n‚Ä¢ Ensure you are correctly covered for your specific risks\n\nAre you available for a quick call this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  } else if (type === 'followup') {
    email = 'Subject: Following up ‚Äî ' + company + ' Insurance Review\n\nGood day ' + contact + ',\n\nI hope you are well. Following up on my previous message regarding a free insurance review for ' + company + '.\n\nThe review takes only 15 minutes and could result in meaningful savings on your current premium.\n\nWould you have a few minutes this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  } else {
    email = 'Subject: Your Policy Renewal is Coming Up ‚Äî ' + company + '\n\nGood day ' + contact + ',\n\nI hope all is well at ' + company + '. Your policy renewal is approaching and I want to make sure you are getting the best possible cover at the best rate.\n\nAs your Outsurance specialist, I will review your current policy and present you with the most competitive options available.\n\nCan we schedule a quick call this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + '\n' + phone;
  }
  document.getElementById('emailOutput').textContent = email;
  document.getElementById('copyEmailBtn').style.display = 'inline-flex';
  stats.emails = (stats.emails || 0) + 1;
  updateStatsDB();
  refreshHome();
  generateWA(company, contact, broker, phone);
}
function generateWA(company, contact, broker, phone) {
  var msgs = [
    { label: 'Intro Message', text: 'Good day ' + contact + ', this is ' + broker + ' from Outsurance. I specialise in commercial insurance for businesses like ' + company + '. Do you have 2 min for a quick question about your cover?' },
    { label: 'Follow-up', text: 'Hi ' + contact + ', ' + broker + ' from Outsurance. Following up ‚Äî I have a quick comparison ready for ' + company + '. Can we connect briefly this week?' },
    { label: 'Value Hook', text: 'Hi, ' + broker + ' here from Outsurance. Quick question: when last did someone review your business insurance? Many clients save significantly after a comparison. Worth 15 min?' }
  ];
  var html = '';
  msgs.forEach(function(m) {
    html += '<div class="wa-bubble" onclick="window.open(\'https://wa.me/?text=' + encodeURIComponent(m.text) + '\',\'_blank\')"><div class="wa-bubble-label">' + m.label + ' ‚Äî tap to open WhatsApp</div>' + esc(m.text) + '</div>';
  });
  document.getElementById('waMessages').innerHTML = html;
}
function copyEmail() {
  var text = document.getElementById('emailOutput').textContent;
  navigator.clipboard.writeText(text).then(function() { showToast('Email copied'); }).catch(function() { showToast('Select and copy manually'); });
}

// ============ FOLLOW-UPS ============
function renderFollowups() {
  var today = new Date(); today.setHours(0,0,0,0);
  var overdue = [], todayArr = [], upcoming = [];
  leads.forEach(function(lead, idx) {
    if (!lead.followup) return;
    var fd = new Date(lead.followup); fd.setHours(0,0,0,0);
    if (fd < today) overdue.push({ lead: lead, idx: idx, dateStr: lead.followup });
    else if (fd.getTime() === today.getTime()) todayArr.push({ lead: lead, idx: idx, dateStr: 'Today' });
    else if (fd <= new Date(today.getTime() + 7 * 86400000)) upcoming.push({ lead: lead, idx: idx, dateStr: lead.followup });
  });
  se('fuOverdue', overdue.length); se('fuToday', todayArr.length); se('fuUpcoming', upcoming.length); se('followupBadge', overdue.length);
  var html = '';
  if (!overdue.length && !todayArr.length && !upcoming.length) {
    html = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-title">All clear</div><div class="empty-desc">No follow-ups due. Add leads and set follow-up dates.</div></div>';
  }
  function grp(arr, cls, label) {
    if (!arr.length) return;
    html += '<div style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px;">' + label + '</div>';
    arr.forEach(function(item) {
      html += '<div class="followup-item ' + cls + '"><div class="followup-left"><div class="followup-company">' + esc(item.lead.company||'Unknown') + '</div><div class="followup-meta">' + esc(item.lead.industry||'') + (item.lead.phone ? ' ¬∑ ' + item.lead.phone : '') + '</div></div><span class="followup-when">' + item.dateStr + '</span><button class="btn btn-secondary btn-sm" onclick="openNotes(' + item.idx + ')">Update</button><button class="btn btn-secondary btn-sm" onclick="waLead(' + item.idx + ')">WhatsApp</button></div>';
    });
  }
  grp(overdue, 'overdue', 'Overdue');
  grp(todayArr, 'today', 'Today');
  grp(upcoming, 'upcoming', 'Upcoming (7 days)');
  document.getElementById('followupList').innerHTML = html;
}

// ============ STATS ============
function renderStats() {
  var total=leads.length, hot=0, closed=0;
  leads.forEach(function(l) { if(scoreLead(l)>=4) hot++; if(l.status==='Closed') closed++; });
  var conv = total>0 ? Math.round((closed/total)*100) : 0;
  se('statLeads',total); se('statEmails',stats.emails||0); se('statDeals',stats.deals||0);
  se('statConversion',conv+'%'); se('statHot',hot); se('statCalls',stats.calls||0);
  // Pipeline breakdown
  var counts = {Hot:0,Warm:0,Cold:0,Emailed:0,Closed:0};
  leads.forEach(function(l) { if(counts[l.status]!==undefined) counts[l.status]++; });
  var colors = {Hot:'var(--danger)',Warm:'var(--warn)',Cold:'var(--cold)',Emailed:'#a78bfa',Closed:'var(--accent)'};
  var pbEl = document.getElementById('pipelineBreakdown');
  if (pbEl) {
    var bd = '';
    Object.keys(counts).forEach(function(k) {
      if (counts[k]>0) {
        var pct = total>0 ? Math.round(counts[k]/total*100) : 0;
        bd += '<div class="bar-row"><div class="bar-label">'+k+'</div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%;background:'+colors[k]+';"></div></div><div class="bar-num">'+counts[k]+'</div></div>';
      }
    });
    pbEl.innerHTML = bd || '<div style="color:var(--text2);font-size:13px;">No leads yet.</div>';
  }
  // Weekly activity
  var days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  var vals = days.map(function() { return Math.floor(Math.random()*20+5); });
  var max = Math.max.apply(null,vals)||1;
  var bc = document.getElementById('barChart');
  if (bc) bc.innerHTML = days.map(function(d,i) {
    return '<div class="bar-row"><div class="bar-label">'+d+'</div><div class="bar-track"><div class="bar-fill" style="width:'+Math.round(vals[i]/max*100)+'%;"></div></div><div class="bar-num">'+vals[i]+'</div></div>';
  }).join('');
}
async function logDeal() {
  var c = document.getElementById('dealCompany').value.trim();
  if (!c) { showToast('Enter company name'); return; }
  stats.deals = (stats.deals||0) + 1;
  var idx = leads.findIndex(function(l) { return l.company && l.company.toLowerCase() === c.toLowerCase(); });
  if (idx > -1) { await sb.from('leads').update({ status: 'Closed' }).eq('id', leads[idx].id); leads[idx].status = 'Closed'; }
  updateStatsDB(); renderStats(); document.getElementById('dealCompany').value = '';
  showToast('Deal logged ‚Äî well done! üéâ');
}

// ============ CALL SCRIPT ============
async function logCall() {
  stats.calls = (stats.calls||0) + 1;
  updateStatsDB(); updateCallUI(); refreshHome();
}
function resetCalls() { stats.calls = 0; updateStatsDB(); updateCallUI(); refreshHome(); }
function updateCallUI() {
  var target = profile.target || 90;
  se('callCount', stats.calls||0); se('callTarget', target);
  var pct = Math.min(100, Math.round(((stats.calls||0)/target)*100));
  var p = document.getElementById('callProgress'); if (p) p.style.width = pct + '%';
}
async function updateStatsDB() {
  if (!currentUser) return;
  await sb.from('stats').upsert({ user_id: currentUser.id, emails: stats.emails||0, calls: stats.calls||0, deals: stats.deals||0, updated_at: new Date().toISOString() });
}

// ============ PROFILE ============
function loadProfileUI() {
  document.getElementById('profName').value = profile.name || '';
  document.getElementById('profPhone').value = profile.phone || '';
  document.getElementById('profBranch').value = profile.branch || '';
  document.getElementById('profEmail').value = profile.email || (currentUser ? currentUser.email : '');
  document.getElementById('profTarget').value = profile.target || 90;
  updateSigPreview();
  var pa = document.getElementById('profileAvatar');
  if (pa) pa.textContent = profile.name ? profile.name[0].toUpperCase() : 'B';
}
async function saveProfile() {
  profile.name = document.getElementById('profName').value.trim();
  profile.phone = document.getElementById('profPhone').value.trim();
  profile.branch = document.getElementById('profBranch').value.trim();
  profile.email = document.getElementById('profEmail').value.trim();
  profile.target = parseInt(document.getElementById('profTarget').value) || 90;
  await sb.from('profiles').upsert({ id: currentUser.id, name: profile.name, phone: profile.phone, branch: profile.branch, email: profile.email, target: profile.target });
  updateSigPreview();
  var pa = document.getElementById('profileAvatar'); if (pa && profile.name) pa.textContent = profile.name[0].toUpperCase();
  var sh = document.getElementById('scriptHook'); if (sh && profile.name) sh.textContent = '"My name is ' + profile.name + ' from Outsurance. I just have one quick question about your business insurance."';
  var nu = document.getElementById('navUser'); if (nu) nu.textContent = profile.name || '';
  se('callTarget', profile.target || 90);
  refreshHome(); showToast('Profile saved');
}
function updateSigPreview() {
  var sp = document.getElementById('sigPreview'); if (!sp) return;
  if (!profile.name) { sp.textContent = 'Save your profile to see your signature preview.'; return; }
  sp.innerHTML = '<strong>' + esc(profile.name) + '</strong><br>Commercial Insurance Specialist<br>Outsurance' + (profile.branch ? ' ‚Äî ' + esc(profile.branch) : '') + (profile.phone ? '<br>' + esc(profile.phone) : '') + (profile.email ? '<br>' + esc(profile.email) : '');
}

// ============ TOAST ============
function showToast(msg) {
  var t = document.getElementById('toast');
  t.innerHTML = '<span style="color:var(--accent);font-weight:700;margin-right:8px;">‚úì</span>' + esc(msg);
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}


// ============================================================
// AI AGENT ENGINE ‚Äî LeadFlow v9
// Rules:
//   AUTO:       Score leads, set follow-ups, promote status, flag overdue
//   ASK FIRST:  Before ANY outreach, before acting on >R100k estimated premium leads
//   SEQUENCE:   Email ‚Üí WhatsApp only if opened/no reply 24h
// ============================================================

var activityLog = [];
var agentSettings = { score:true, followup:true, brief:true, draft:true, overdue:true, promote:false };
var pendingApprovals = [];
var currentApprovalIdx = null;

// High-premium industries (est. annual premium >R100k)
var HIGH_PREMIUM_INDUSTRIES = ['Mining','Manufacturing','Transport & Logistics','Construction','Chemical Industry','Steel & Metal Fabrication','Engineering','Taxi & Bus Operators','Courier & Delivery','Warehousing & Storage','Solar & Renewable Energy','Petrochemical','Petrol Stations & Garages'];

function isHighPremium(lead) {
  if (!lead.industry) return false;
  for (var i=0; i<HIGH_PREMIUM_INDUSTRIES.length; i++) {
    if (lead.industry.indexOf(HIGH_PREMIUM_INDUSTRIES[i]) > -1) return true;
  }
  return false;
}

function loadAgentSettings() {
  try { var s = JSON.parse(localStorage.getItem('lf_agent')||'{}'); Object.assign(agentSettings, s); } catch(e) {}
  ['score','followup','brief','draft','overdue','promote'].forEach(function(k) {
    var el = document.getElementById('ag_'+k); if (el) el.checked = agentSettings[k] !== false;
  });
}
function saveAgentSettings() {
  ['score','followup','brief','draft','overdue','promote'].forEach(function(k) {
    var el = document.getElementById('ag_'+k); if (el) agentSettings[k] = el.checked;
  });
  try { localStorage.setItem('lf_agent', JSON.stringify(agentSettings)); } catch(e) {}
  agentLog('Agent settings updated', 'info');
  showToast('Agent settings saved');
}

function agentLog(msg, type) {
  var el = document.getElementById('agentLog'); if (!el) return;
  var now = new Date(); var t = pad2(now.getHours())+':'+pad2(now.getMinutes())+':'+pad2(now.getSeconds());
  var cls = 'log-'+(type||'info');
  var line = document.createElement('div'); line.className = 'log-line';
  line.innerHTML = '<span class="log-time">'+t+'</span><span class="'+cls+'"> '+esc(msg)+'</span>';
  el.insertBefore(line, el.firstChild);
  if (el.children.length > 60) el.removeChild(el.lastChild);
}
function clearAgentLog() {
  var el = document.getElementById('agentLog');
  if (el) el.innerHTML = '<div class="log-line"><span class="log-time">--:--:--</span><span class="log-info"> Log cleared.</span></div>';
}

function addActivity(text, type) {
  var now = new Date(); var t = pad2(now.getHours())+':'+pad2(now.getMinutes());
  activityLog.unshift({text:text, type:type||'info', time:t});
  if (activityLog.length > 20) activityLog.pop();
  renderActivityFeed();
}
function pad2(n) { return String(n).padStart(2,'0'); }
function renderActivityFeed() {
  var el = document.getElementById('activityFeed'); if (!el) return;
  if (!activityLog.length) { el.innerHTML = '<div style="font-size:13px;color:var(--text2);padding:8px 0;">No activity yet. Start adding leads.</div>'; return; }
  var cols = {info:'var(--accent2)', agent:'#8b5cf6', deal:'var(--accent)', warn:'var(--warn)'};
  el.innerHTML = activityLog.slice(0,8).map(function(a) {
    return '<div class="activity-item"><div class="activity-dot" style="background:'+(cols[a.type]||'var(--text2)')+'"></div><div class="activity-text">'+esc(a.text)+'</div><div class="activity-time">'+a.time+'</div></div>';
  }).join('');
}

function runAgentBrief() {
  agentLog('Running full pipeline analysis...', 'agent');
  var today = new Date(); today.setHours(0,0,0,0);
  var overdueCnt=0, hotCnt=0, noPhone=0, dueToday=0, highPremCnt=0;
  pendingApprovals = [];

  leads.forEach(function(lead) {
    var sc = scoreLead(lead);
    if (sc >= 4) hotCnt++;
    if (!lead.phone) noPhone++;
    if (isHighPremium(lead)) highPremCnt++;
    if (lead.followup) {
      var fd = new Date(lead.followup); fd.setHours(0,0,0,0);
      if (fd < today) overdueCnt++;
      if (fd.getTime() === today.getTime()) dueToday++;
    }
    // Draft outreach for hot leads ‚Äî requires approval
    if (agentSettings.draft && sc >= 4 && (!lead.notes || lead.notes.length < 5)) {
      var broker = profile.name || '[Broker]';
      var phone  = profile.phone || '';
      var branch = profile.branch || 'Outsurance';
      var hp = isHighPremium(lead);
      var draft = 'Subject: Free Business Insurance Review ‚Äî ' + (lead.company||'your business') + '\n\nGood day,\n\nMy name is ' + broker + ' from Outsurance, ' + branch + '.\n\nI noticed ' + (lead.company||'your business') + ' operates in the ' + (lead.industry||'commercial') + ' sector. I specialise in protecting ' + (lead.industry||'commercial') + ' businesses.\n\nI\'d like to offer a FREE 15-minute review ‚Äî no obligation.\n\nWhen would suit you this week?\n\nKind regards,\n' + broker + '\nOutsurance ‚Äî ' + branch + (phone ? '\n' + phone : '');
      pendingApprovals.push({
        id: 'draft_'+lead.id,
        title: 'Draft email for ' + (lead.company||'lead'),
        sub: 'Score '+sc+'/5 ¬∑ '+(lead.industry||'')+(hp?' ¬∑ ‚ö† HIGH-PREMIUM LEAD (>R100k)':''),
        body: draft,
        highPremium: hp,
        premiumWarning: hp ? '‚ö† This is a high-premium industry lead (est. >R100k annual premium). You set a rule to review these manually.' : '',
        onApprove: function(l) { return function() {
          showPanel('email');
          setTimeout(function() {
            var c = document.getElementById('emailCompany'); if(c) c.value = l.company||'';
            var co = document.getElementById('emailContact'); if(co) co.value = l.contact||'';
            generateEmail();
          }, 150);
        }; }(lead)
      });
    }
  });

  // Update brief counters
  setSafe('briefToday', dueToday);
  setSafe('briefOverdue', overdueCnt);
  setSafe('briefHot', hotCnt);
  setSafe('briefPipeline', leads.length);

  agentLog('Hot leads: '+hotCnt+' ¬∑ Overdue: '+overdueCnt+' ¬∑ High-premium: '+highPremCnt, 'agent');
  if (noPhone > 0) agentLog(noPhone+' leads missing phone ‚Äî update in Pipeline', 'warn');
  if (overdueCnt > 0) agentLog(overdueCnt+' overdue follow-ups need attention NOW', 'warn');

  // Insight
  var insight = '';
  if (leads.length === 0) {
    insight = 'ü§ñ No leads yet. Head to AI Lead Search to find your first SA businesses.';
  } else {
    var convRate = leads.length > 0 ? Math.round(((stats.deals||0)/leads.length)*100) : 0;
    insight = 'ü§ñ Pipeline: '+leads.length+' leads ¬∑ '+convRate+'% conversion. ';
    if (hotCnt > 0) insight += hotCnt+' hot leads need calls today ‚Äî do these first. ';
    if (overdueCnt > 0) insight += overdueCnt+' follow-ups overdue. ';
    if (highPremCnt > 0) insight += highPremCnt+' high-premium leads flagged for manual review. ';
    if (pendingApprovals.length > 0) insight += pendingApprovals.length+' draft emails queued for your approval.';
  }
  var insightEl = document.getElementById('agentInsight');
  if (insightEl) { insightEl.textContent = insight; insightEl.style.display = 'block'; }

  renderApprovalQueue();
  agentLog('Analysis complete. '+pendingApprovals.length+' actions queued for approval.', 'success');
  addActivity('AI Agent: full analysis run ¬∑ '+pendingApprovals.length+' actions queued', 'agent');
  refreshHome();
}

function setSafe(id, v) { var el=document.getElementById(id); if(el) el.textContent=v; }

function renderApprovalQueue() {
  var queueEl    = document.getElementById('agentQueue');
  var queueItems = document.getElementById('agentQueueItems');
  var approvalCard = document.getElementById('approvalCard');
  var approvalList = document.getElementById('approvalList');

  if (!pendingApprovals.length) {
    if (queueEl) queueEl.style.display = 'none';
    if (approvalCard) approvalCard.style.display = 'none';
    return;
  }
  if (queueEl) queueEl.style.display = 'block';
  if (approvalCard) approvalCard.style.display = 'block';

  function buildHTML() {
    return pendingApprovals.map(function(a, i) {
      var hpStyle = a.highPremium ? 'border-color:rgba(239,68,68,0.3);' : '';
      return '<div class="agent-action-item" style="'+hpStyle+'">'+
        '<div><div class="agent-action-text">'+esc(a.title)+(a.highPremium ? ' <span style="color:var(--danger);font-size:10px;font-weight:700;">‚ö† HIGH PREMIUM</span>' : '')+'</div><div class="agent-action-meta">'+esc(a.sub)+'</div></div>'+
        '<div class="agent-action-btns"><button class="btn btn-sm btn-danger" onclick="dismissApproval('+i+')">Dismiss</button><button class="btn btn-sm btn-agent" onclick="openApprovalModal('+i+')">Review ‚Üí</button></div></div>';
    }).join('');
  }
  if (queueItems) queueItems.innerHTML = buildHTML();
  if (approvalList) approvalList.innerHTML = buildHTML();
}

function openApprovalModal(i) {
  currentApprovalIdx = i;
  var a = pendingApprovals[i]; if (!a) return;
  setSafe('approvalModalTitle', a.title);
  setSafe('approvalModalSub',   a.sub);
  document.getElementById('approvalModalBody').textContent = a.body;
  var pw = document.getElementById('premiumWarning');
  if (pw) { if (a.premiumWarning) { pw.textContent = a.premiumWarning; pw.style.display='block'; } else { pw.style.display='none'; } }
  openModal('approvalModal');
}
function approveApproval() {
  if (currentApprovalIdx === null) return;
  var a = pendingApprovals[currentApprovalIdx];
  closeModal('approvalModal');
  if (a && a.onApprove) a.onApprove();
  agentLog('Approved: '+a.title, 'success');
  addActivity('Approved: '+a.title, 'agent');
  dismissApproval(currentApprovalIdx);
}
function rejectApproval() {
  closeModal('approvalModal');
  if (currentApprovalIdx !== null) {
    agentLog('Rejected: '+(pendingApprovals[currentApprovalIdx]||{title:''}).title, 'warn');
    dismissApproval(currentApprovalIdx);
  }
}
function dismissApproval(i) {
  pendingApprovals.splice(i, 1); currentApprovalIdx = null;
  renderApprovalQueue();
}
function agentDraftOutreach() { runAgentBrief(); showToast('Outreach queue drafted ‚Äî review in approval queue above'); }

// Override showPanel to also update mobile nav
var _origShowPanel = null;
function showPanelWithMobile(id) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.tab-btn, .mob-tab').forEach(function(b) { b.classList.remove('active'); });
  var p = document.getElementById('panel-'+id); if (p) p.classList.add('active');
  ['nav-'+id, 'mob-'+id].forEach(function(nid) { var n=document.getElementById(nid); if(n) n.classList.add('active'); });
  if (id==='home')      refreshHome();
  if (id==='pipeline')  renderPipeline();
  if (id==='followups') renderFollowups();
  if (id==='stats')     renderStats();
  if (id==='profile')   loadProfileUI();
  window.scrollTo(0,0);
}

// Responsive home grid
function handleResize() {
  var hg = document.getElementById('homeGridTwo');
  if (hg) hg.style.gridTemplateColumns = window.innerWidth < 900 ? '1fr' : '1fr 300px';
}
window.addEventListener('resize', handleResize);

window.initGoogleMaps = initGoogleMaps;
loadAgentSettings();
handleResize();
</script>
</body>
</html>
